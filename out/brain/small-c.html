<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="icon" type="image/png" href="/favicon.png" />
		<meta name="author" content="nes" />
		<title>Making a small working C binary</title>
		<link rel="stylesheet" href="/assets/styles.css" />
	</head>
	<body>
	  <article>

<header>
<h1>Making a small working C binary</h1>
</header>
<br/>
So out of curiosity, I was wondering how small I could get a non trivial program<br/>
without actually changing the code itself.<br/>
<br/>
I might be using "non trivial" wrongly here but I mean a program that can actually do something.<br/>
<br/>
For a really extreme devlve into getting a teensy tiny binary, see: <a href="https://www.muppetlabs.com/~breadbox/software/tiny/teensy.html">https://www.muppetlabs.com/~breadbox/software/tiny/teensy.html</a><br/>
<br/>
Well, let us start with a non trivial program and go from there,<br/>
For this I will make use of the wonderful <a href="https://github.com/erkkah/tigr">tigr graphics library</a><br/>
<br/>
The compiler I am using is clang.<br/>
<br/>
I wrote a little demo work that'll do for now.<br/>
<pre>
<code><span style="color:#8b6c37">#include &lt;stdlib.h&gt;</span>
<span style="color:#8b6c37">#include</span> <span style="color:#2d6bb1">&quot;tigr.h&quot;</span><span style="color:#8b6c37"></span>
<span style="color:#8b6c37">#include &lt;time.h&gt;</span>
<span style="color:#8b6c37">#include &lt;stdio.h&gt;</span>

<span style="color:#48bac2; font-weight:bold">int</span> <span style="color:#c48218; font-weight:bold">randomNo</span><span style="color:#181818">(</span><span style="color:#48bac2; font-weight:bold">int</span> min<span style="color:#181818">,</span> <span style="color:#48bac2; font-weight:bold">int</span> max<span style="color:#181818">) {</span>
  <span style="color:#a94598; font-weight:bold">return</span> min <span style="color:#181818">+</span> <span style="color:#c48218; font-weight:bold">rand</span><span style="color:#181818">() / (</span>RAND_MAX <span style="color:#181818">/ (</span>max <span style="color:#181818">-</span> min <span style="color:#181818">+</span> <span style="color:#c43e18">1</span><span style="color:#181818">) +</span> <span style="color:#c43e18">1</span><span style="color:#181818">);</span>
<span style="color:#181818">}</span>

<span style="color:#48bac2; font-weight:bold">int</span> <span style="color:#c48218; font-weight:bold">main</span><span style="color:#181818">() {</span>

  <span style="color:#c48218; font-weight:bold">srand</span><span style="color:#181818">(</span><span style="color:#c48218; font-weight:bold">time</span><span style="color:#181818">(</span>NULL<span style="color:#181818">));</span>

  Tigr <span style="color:#181818">&ast;</span>screen <span style="color:#181818">=</span> <span style="color:#c48218; font-weight:bold">tigrWindow</span><span style="color:#181818">(</span><span style="color:#c43e18">320</span><span style="color:#181818">,</span> <span style="color:#c43e18">240</span><span style="color:#181818">,</span> <span style="color:#38781c">&quot;Hello&quot;</span><span style="color:#181818">,</span> <span style="color:#c43e18">0</span><span style="color:#181818">);</span>
  <span style="color:#48bac2; font-weight:bold">int</span> x<span style="color:#181818">,</span> y<span style="color:#181818">;</span>
  <span style="color:#48bac2; font-weight:bold">char</span> <span style="color:#181818">&ast;</span>fmt <span style="color:#181818">=</span> <span style="color:#c48218; font-weight:bold">malloc</span><span style="color:#181818">(</span><span style="color:#c43e18">100</span><span style="color:#181818">);</span>
  <span style="color:#a94598; font-weight:bold">while</span> <span style="color:#181818">(!</span><span style="color:#c48218; font-weight:bold">tigrClosed</span><span style="color:#181818">(</span>screen<span style="color:#181818">)) {</span>
    <span style="color:#c48218; font-weight:bold">tigrClear</span><span style="color:#181818">(</span>screen<span style="color:#181818">,</span> <span style="color:#c48218; font-weight:bold">tigrRGB</span><span style="color:#181818">(</span><span style="color:#c43e18">0x11</span><span style="color:#181818">,</span> <span style="color:#c43e18">0x11</span><span style="color:#181818">,</span> <span style="color:#c43e18">0x11</span><span style="color:#181818">));</span>

    <span style="color:#c48218; font-weight:bold">tigrPrint</span><span style="color:#181818">(</span>screen<span style="color:#181818">,</span> tfont<span style="color:#181818">,</span> <span style="color:#c43e18">120</span><span style="color:#181818">,</span> <span style="color:#c43e18">110</span><span style="color:#181818">,</span> <span style="color:#c48218; font-weight:bold">tigrRGB</span><span style="color:#181818">(</span><span style="color:#c43e18">0xf0</span><span style="color:#181818">,</span> <span style="color:#c43e18">0xf0</span><span style="color:#181818">,</span> <span style="color:#c43e18">0xf0</span><span style="color:#181818">),</span>
              <span style="color:#38781c">&quot;Hello, world.&quot;</span><span style="color:#181818">);</span>
	<span style="color:#c48218; font-weight:bold">snprintf</span><span style="color:#181818">(</span>fmt<span style="color:#181818">,</span> <span style="color:#c43e18">100</span><span style="color:#181818">,</span> <span style="color:#38781c">&quot;%d, %d&quot;</span><span style="color:#181818">,</span> x<span style="color:#181818">,</span> y<span style="color:#181818">);</span>
	<span style="color:#c48218; font-weight:bold">tigrPrint</span><span style="color:#181818">(</span>screen<span style="color:#181818">,</span> tfont<span style="color:#181818">,</span> <span style="color:#c43e18">120</span><span style="color:#181818">,</span> <span style="color:#c43e18">110</span> <span style="color:#181818">+</span> <span style="color:#c43e18">16</span><span style="color:#181818">,</span> <span style="color:#c48218; font-weight:bold">tigrRGB</span><span style="color:#181818">(</span><span style="color:#c43e18">0xf0</span><span style="color:#181818">,</span> <span style="color:#c43e18">0xf0</span><span style="color:#181818">,</span> <span style="color:#c43e18">0xf0</span><span style="color:#181818">),</span> fmt<span style="color:#181818">);</span>

    <span style="color:#c48218; font-weight:bold">tigrMouse</span><span style="color:#181818">(</span>screen<span style="color:#181818">, &amp;</span>x<span style="color:#181818">, &amp;</span>y<span style="color:#181818">,</span> NULL<span style="color:#181818">);</span>
    <span style="color:#c48218; font-weight:bold">tigrFillCircle</span><span style="color:#181818">(</span>screen<span style="color:#181818">,</span> x<span style="color:#181818">,</span> y<span style="color:#181818">,</span> <span style="color:#c43e18">8</span><span style="color:#181818">,</span> <span style="color:#c48218; font-weight:bold">tigrRGB</span><span style="color:#181818">(</span><span style="color:#c43e18">0xff</span><span style="color:#181818">,</span> <span style="color:#c43e18">0x00</span><span style="color:#181818">,</span> <span style="color:#c43e18">0x00</span><span style="color:#181818">));</span>

    <span style="color:#a94598; font-weight:bold">for</span> <span style="color:#181818">(</span><span style="color:#48bac2; font-weight:bold">int</span> i <span style="color:#181818">=</span> <span style="color:#c43e18">0</span><span style="color:#181818">;</span> i <span style="color:#181818">&lt;</span> <span style="color:#c43e18">100</span><span style="color:#181818">;</span> i<span style="color:#181818">++) {</span>
      <span style="color:#48bac2; font-weight:bold">int</span> x <span style="color:#181818">=</span> <span style="color:#c48218; font-weight:bold">randomNo</span><span style="color:#181818">(</span><span style="color:#c43e18">0</span><span style="color:#181818">,</span> <span style="color:#c43e18">320</span><span style="color:#181818">);</span>
      <span style="color:#48bac2; font-weight:bold">int</span> y <span style="color:#181818">=</span> <span style="color:#c48218; font-weight:bold">randomNo</span><span style="color:#181818">(</span><span style="color:#c43e18">0</span><span style="color:#181818">,</span> <span style="color:#c43e18">240</span><span style="color:#181818">);</span>
      <span style="color:#c48218; font-weight:bold">tigrLine</span><span style="color:#181818">(</span>screen<span style="color:#181818">,</span> x<span style="color:#181818">,</span> y<span style="color:#181818">,</span> x<span style="color:#181818">,</span> y <span style="color:#181818">+</span> <span style="color:#c43e18">10</span><span style="color:#181818">,</span> <span style="color:#c48218; font-weight:bold">tigrRGB</span><span style="color:#181818">(</span><span style="color:#c43e18">0x00</span><span style="color:#181818">,</span> <span style="color:#c43e18">0x00</span><span style="color:#181818">,</span> <span style="color:#c43e18">0xff</span><span style="color:#181818">));</span>
    <span style="color:#181818">}</span>

    <span style="color:#c48218; font-weight:bold">tigrUpdate</span><span style="color:#181818">(</span>screen<span style="color:#181818">);</span>
  <span style="color:#181818">}</span>
  <span style="color:#c48218; font-weight:bold">free</span><span style="color:#181818">(</span>fmt<span style="color:#181818">);</span>
  <span style="color:#c48218; font-weight:bold">tigrFree</span><span style="color:#181818">(</span>screen<span style="color:#181818">);</span>
  <span style="color:#a94598; font-weight:bold">return</span> <span style="color:#c43e18">0</span><span style="color:#181818">;</span>
<span style="color:#181818">}</span>
</code>
</pre>
Nothing flashy, it just opens a window, draws some text and some rain.<br/>
Compiling with <code>cc app.c tigr.c -o app -lGl -lX11</code> gives us the executable.<br/>
<br/>
<code>du -sh</code> tells us the file is 76kb, We can do better than that.<br/>
<br/>
<h2 id="compiler-flags">Compiler Flags</h2>
<p>
How about telling the compiler to optimize for size with the <code>-Os</code> flag?<br/>
I was really expecting a negligible change but I was happily suprised, The new binary is 68kb,<br/>
a decrease of 10.52%, Not bad if I say so myself.<br/>
However in my experience this doesnt always happen, quite often the decrease is so small that du wont even measure it<br/>
<br/>
You can find out what it does by starting from here, <a href="https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html#Optimize-Options">https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html#Optimize-Options</a><br/>
But I don't find it all that interesting.<br/>
<br/>
Let's go further, On searching google on ways to decrease binary size, You'll come across the <code>-s</code> flag, But what does this do?<br/>
The gcc docs give us the answer,<br/>
<br/>
<b>-s:</b> Remove all symbol table and relocation information from the executable.<br/>
<br/>
But what does that mean?<br/>
<br/>
<a href="https://en.wikipedia.org/wiki/Symbol_table">Wikipedia</a> tells us that it is a table of identifiers from the source and where they are in the binary (reloc info).<br/>
Useful in some instances sure but we don't care about this, how bad is it?<br/>
<br/>
Using <code>nm</code> we can print out the symbol table in its entirety,<br/>
<pre>
<code>                 U __assert_fail@GLIBC_2.2.5
0000000000405546 t begin
0000000000405bb0 t bits
0000000000405c2d t block
0000000000405f9a t border
000000000040e414 B __bss_start
0000000000408131 t build
                 U calloc@GLIBC_2.2.5
000000000040e420 b completed.0
00000000004080f6 t copy
000000000040a6e0 r cp1252
000000000040a940 r crctable
// 255 lines in total
</code>
</pre>
<br/>
This means a lot of data is sitting in our binary doing nothing, so when we add the <code>-s</code> flag we can get rid of it,<br/>
This gets us to <code>56kb</code>, so 26% smaller than our original 76kb binary, not bad<br/>
<br/>
The rust folks seem to always have trouble with binary size 😉, Maybe they have some ideas?<br/>
Consulting <a href="https://github.com/johnthagen/min-sized-rust">https://github.com/johnthagen/min-sized-rust</a> , We find one thing of interest, Link Time Optimization (LTO)..<br/>
<br/>
</p>
<h3 id="what-is lto?">What is LTO?</h3>
<p>
Link Time Optimization (LTO) gives GCC the capability of dumping its internal representation (GIMPLE) to disk, so that all the different compilation units that make up a single executable can be optimized as a single module. This expands the scope of inter-procedural optimizations to encompass the whole program (or, rather, everything that is visible at link time). <br/>
<br/>
Learn More: <a href="https://en.wikipedia.org/wiki/Interprocedural_optimization#WPO_and_LTO">https://en.wikipedia.org/wiki/Interprocedural_optimization#WPO_and_LTO</a><br/>
<br/>
It's enabled with <code>-flto</code><br/>
Okay, but what does it do for us?<br/>
<br/>
Quite a bit, Using it we have shaved off 16kb to reach 40kb, so in total a 47% decrease of our initial 76kb, not bad at all<br/>
<b>NOTE</b>: Enabling -flto sometimes caused me a segfault at program start with clang, but this didnt occur with gcc, so<br/>
YMMV<br/>
<br/>
</p>
<h2 id="executable-packing">Executable Packing</h2>
<p>
If you wanted to go even furthur you could try <a href="https://upx.github.io/">UPX</a>, Which actually compresses your biniary and this works since<br/>
the decompression code + compressed data ends up smaller than the initial binary.<br/>
<br/>
I am not a big fan of such an approach, feels like cheating but it is an actual approach so how much does it help?<br/>
Running it with the highest compression level (-9) on our 40kb binary yields a binary size of 24kb...<br/>
Wow that is actually amazing, I didnt think it would reduce the size that much..<br/>
I should use this more.. wow, I should've tried this earlier...<br/>
NOTE: Since upx is often used in malware, There are chances it might get flagged by an antivirus,<br/>
But running through virus total shows only <a href="https://is.gd/MtqIMG">results</a> from Google & Ikarus(?)<br/>
<br/>
<pre>
<code>76K     min
68K     min-Os
56K     min-Os-s
40K     min-Os-s-flto
24K     min-Os-s-flto-upx
</code>
</pre>
<br/>
So in total we managed to decrease our binary by <b>68%</b>, Less than half of its original size<br/>
I am very pleased with that..<br/>
<br/>
Of course, even this isn't enough to achieve feats like .kkrieger, A entire 3d fps game demo is a extremely impressive 95kb,<br/>
When code is <i>actually written</i> to be small, and optimized to the limit towards that purpose.<br/>
Learn more about how it's so small:<br/>
<a href="https://fgiesen.wordpress.com/2012/04/08/metaprogramming-for-madmen/">https://fgiesen.wordpress.com/2012/04/08/metaprogramming-for-madmen/</a><br/>
<a href="https://www.youtube.com/watch?v=bD1wWY1YD-M">https://www.youtube.com/watch?v=bD1wWY1YD-M</a><br/>
<br/>
Since in a web enviroment, files are usually transferred while being gzip-compressed, UPX would be negligible for .wasm files and it doesnt support it anyway.<br/>
			<footer style="margin-bottom: 2em;">
				<a href="/out/index.html">Return Home</a>
			</footer>
	  </article>
	</body>
</html>
