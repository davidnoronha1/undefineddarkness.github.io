#!/usr/bin/env bash
#shellcheck disable=2059

# Toad:
# This is meant to be my super minimal SSG and meant to only fulfill my needs and do nothing more

# Configuration
port=5000

# Extract relevant parts of the template
buffer=
pre=
post=
while read -r line; do
	case "$line" in
		"!CONTENT!")
			pre=$buffer
			buffer=
			continue
			;;
	esac
	buffer+="$line"$'\n'
done < ./template.html
post=$buffer

server="deno run --unstable -A ./tool/server/server.ts --port=$port --log=false --live=false "

get-modified-time () {
	stat -c '%y' $1 | cut -d' ' -f1
}

build-file () {
	out=${1/src/out}

	case "${out#*.}" in
		"html")
			cp -f "$1" "$out"
			printf "Building \033[34m%s\033[0m	\033[32m->\033[0m	\033[34m%s\033[0m\n" "$1" "$out"
			;;
		"md")
			out=${out/.${out#*.}/.html}

			mkdir -p "${out%%.*}"
			printf "Building \033[34m%s\033[0m	\033[32m->\033[0m	\033[34m%s\033[0m\n" "$1" "$out"

			x=${out%%.html}
			x=${x##out/}
			header=${pre/\!TITLE\!/$x}
			t=$(get-modified-time $1)
			header=${header/\!TIME\!/$t}
			printf '%s' "$header" > "$out"
			bash tool/pond.sh "$1" 1>>$out #2>/dev/null # Debug fixes it somehow.. ;-;
			printf '%s' "$post" >> "$out"
			;;
	esac

}

get-title () {
	case "${1#*.}" in
		"html")
			grep -Po -m1 '<(h1|title)>\K.*(?=<\/(\1)>)' $1
			;;
		"md")
			grep -Po -m1 '<h1>\K.*(?=<\/h1>)|# \K.*' $1 
			;;
	esac
}

get-date () {
	printf '%s' "$4"
}

# Generate Article Index: {{{
gen-index () {
	cp ./src/index.html ./out/index.html
	find src/ -type d -not -path 'src/' | while read -r folder; do
		posts=''
		while read -r file_l; do
			[[ $file_l == total* ]] && continue
			file=${file_l##* }
			title=$(get-title $folder/$file)
			[ -z "$title" ] && continue
			f_date=$(get-date $file_l)
			posts="$posts<li>${f_date}	<a href=\"${folder##*/}/${file/.md/.html}\">${title}</a></li>"
		done < <(ls --sort=time --time=creation --time-style='+%d-%b-%y' -1 -o -g $folder)
		sed -i "s@!POSTS-$(tr '[:lower:]' '[:upper:]' <<< "${folder##*/}")!@${posts}@g" ./out/index.html #> ./out/index.html
	done
	printf "Generated Article Index\n"
}
# }}}

post-build () {
		gen-index
}

# Optimize Images: {{{
optimize-image () {
	file=${1%%:*}
	image=${1#*:}
	image_path=$image
	[[ $image == *.webp ]] && return
	echo "Converting $image to WEBP"
	if [[ $image == https://* ]]; then
		echo "Downloading"
		image_path=/assets/images/dump/$(cat /proc/sys/kernel/random/uuid).webp
		curl -L -o .$image_path --progress-bar $image
	fi
	echo "Saved output to $image_path"

	out_image_path=${image_path/.png/.webp}
	out_image_path=${out_image_path/.jpg/.webp}
	cwebp .$image_path -o .$out_image_path -q 90
	initial_size=$(du .$image_path)
	final_size=$(du .$out_image_path)
	if (( ${final_size%%	*} > ${initial_size%%	*} )); then
		echo 'WEBP Conversion war larger than original image!!!'
		rm .$out_image_path
		out_image_path=$image_path
		return
	fi
	echo ">>>> s!$image_path!$out_image_path!g $file"
	sed -i "s!$image!$out_image_path!g" $file

	printf '\n\n'
}
# }}}

case $1 in

	# Serve files with hot reloading
	live)
		printf -- "--- ðŸ§¯ \e[1mLIVE BUILD\e[0m ---\n"
		pkill "${server%% *}"
		$server &  
		
		# Paths to watch
		(
		find src -name "*.md" -or -name '*.html'
		realpath ./template.html
		realpath assets/styles.css
		find tool -name "*.sh"
		echo $0
		) | entr ./generate
		
		# Kill server
		pkill "${server% *}"
		;;

	# Serve without hot realoading
	serve)
		$server
		;;


	debug)
		pond_debug=1 bash tool/pond.sh $2
		;;

	*)
		start_t=$(date +%s.%N)
		mkdir -p src out
		while read -r file; do
			build-file "$file" &
		done < <(find src -name "*.md" -or -name "*.html")

		post-build

		pkill --signal USR1 ${server%% *}
		end_t=$(date +%s.%N)
		printf -- "--- Finished in \e[31m"
		awk "BEGIN{ printf $end_t - $start_t }"
		printf -- "s\e[0m ---\n"
	;;
esac
