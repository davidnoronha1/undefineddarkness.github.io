<span style="color:#0057ae">int</span> <span style="color:#010181">GetCodepoint</span><span style="color:#000000">(</span><span style="color:#0057ae">const char</span> <span style="color:#000000">*</span>text<span style="color:#000000">,</span> <span style="color:#0057ae">int</span> <span style="color:#000000">*</span>codepointSize<span style="color:#000000">){</span>
<span style="color:#838183; font-style:italic">/*</span>
<span style="color:#838183; font-style:italic">    UTF-8 specs from https://www.ietf.org/rfc/rfc3629.txt</span>
<span style="color:#838183; font-style:italic">    Char. number range  |        UTF-8 octet sequence</span>
<span style="color:#838183; font-style:italic">      (hexadecimal)    |              (binary)</span>
<span style="color:#838183; font-style:italic">    --------------------+---------------------------------------------</span>
<span style="color:#838183; font-style:italic">    0000 0000-0000 007F | 0xxxxxxx</span>
<span style="color:#838183; font-style:italic">    0000 0080-0000 07FF | 110xxxxx 10xxxxxx</span>
<span style="color:#838183; font-style:italic">    0000 0800-0000 FFFF | 1110xxxx 10xxxxxx 10xxxxxx</span>
<span style="color:#838183; font-style:italic">    0001 0000-0010 FFFF | 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx</span>
<span style="color:#838183; font-style:italic">*/</span>
    <span style="color:#838183; font-style:italic">// NOTE: on decode errors we return as soon as possible</span>
    <span style="color:#0057ae">int</span> codepoint <span style="color:#000000">=</span> <span style="color:#b07e00">0x3f</span><span style="color:#000000">;</span>   <span style="color:#838183; font-style:italic">// Codepoint (defaults to &apos;?&apos;)</span>
    <span style="color:#0057ae">int</span> octet <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned char</span><span style="color:#000000">)(</span>text<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">]);</span> <span style="color:#838183; font-style:italic">// The first UTF8 octet</span>
    <span style="color:#000000">*</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">1</span><span style="color:#000000">;</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>octet <span style="color:#000000">&lt;=</span> <span style="color:#b07e00">0x7f</span><span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#838183; font-style:italic">// Only one octet (ASCII range x00-7F)</span>
        codepoint <span style="color:#000000">=</span> text<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">];</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">else if</span> <span style="color:#000000">((</span>octet <span style="color:#000000">&amp;</span> <span style="color:#b07e00">0xe0</span><span style="color:#000000">) ==</span> <span style="color:#b07e00">0xc0</span><span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#838183; font-style:italic">// Two octets</span>
        <span style="color:#838183; font-style:italic">// [0]xC2-DF    [1]UTF8-tail(x80-BF)</span>
        <span style="color:#0057ae">unsigned char</span> octet1 <span style="color:#000000">=</span> text<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">];</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>octet1 <span style="color:#000000">==</span> <span style="color:#bf0303">&apos;\0&apos;</span><span style="color:#000000">) || ((</span>octet1 <span style="color:#000000">&gt;&gt;</span> <span style="color:#b07e00">6</span><span style="color:#000000">) !=</span> <span style="color:#b07e00">2</span><span style="color:#000000">)) { *</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">2</span><span style="color:#000000">;</span> <span style="color:#000000; font-weight:bold">return</span> codepoint<span style="color:#000000">; }</span> <span style="color:#838183; font-style:italic">// Unexpected sequence</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>octet <span style="color:#000000">&gt;=</span> <span style="color:#b07e00">0xc2</span><span style="color:#000000">) &amp;&amp; (</span>octet <span style="color:#000000">&lt;=</span> <span style="color:#b07e00">0xdf</span><span style="color:#000000">))</span>
        <span style="color:#000000">{</span>
            codepoint <span style="color:#000000">= ((</span>octet <span style="color:#000000">&amp;</span> <span style="color:#b07e00">0x1f</span><span style="color:#000000">) &lt;&lt;</span> <span style="color:#b07e00">6</span><span style="color:#000000">) | (</span>octet1 <span style="color:#000000">&amp;</span> <span style="color:#b07e00">0x3f</span><span style="color:#000000">);</span>
            <span style="color:#000000">*</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">2</span><span style="color:#000000">;</span>
        <span style="color:#000000">}</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">else if</span> <span style="color:#000000">((</span>octet <span style="color:#000000">&amp;</span> <span style="color:#b07e00">0xf0</span><span style="color:#000000">) ==</span> <span style="color:#b07e00">0xe0</span><span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#838183; font-style:italic">// Three octets</span>
        <span style="color:#0057ae">unsigned char</span> octet1 <span style="color:#000000">=</span> text<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">];</span>
        <span style="color:#0057ae">unsigned char</span> octet2 <span style="color:#000000">=</span> <span style="color:#bf0303">&apos;\0&apos;</span><span style="color:#000000">;</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>octet1 <span style="color:#000000">==</span> <span style="color:#bf0303">&apos;\0&apos;</span><span style="color:#000000">) || ((</span>octet1 <span style="color:#000000">&gt;&gt;</span> <span style="color:#b07e00">6</span><span style="color:#000000">) !=</span> <span style="color:#b07e00">2</span><span style="color:#000000">)) { *</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">2</span><span style="color:#000000">;</span> <span style="color:#000000; font-weight:bold">return</span> codepoint<span style="color:#000000">; }</span> <span style="color:#838183; font-style:italic">// Unexpected sequence</span>
        octet2 <span style="color:#000000">=</span> text<span style="color:#000000">[</span><span style="color:#b07e00">2</span><span style="color:#000000">];</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>octet2 <span style="color:#000000">==</span> <span style="color:#bf0303">&apos;\0&apos;</span><span style="color:#000000">) || ((</span>octet2 <span style="color:#000000">&gt;&gt;</span> <span style="color:#b07e00">6</span><span style="color:#000000">) !=</span> <span style="color:#b07e00">2</span><span style="color:#000000">)) { *</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">3</span><span style="color:#000000">;</span> <span style="color:#000000; font-weight:bold">return</span> codepoint<span style="color:#000000">; }</span> <span style="color:#838183; font-style:italic">// Unexpected sequence</span>
        <span style="color:#838183; font-style:italic">// [0]xE0    [1]xA0-BF       [2]UTF8-tail(x80-BF)</span>
        <span style="color:#838183; font-style:italic">// [0]xE1-EC [1]UTF8-tail    [2]UTF8-tail(x80-BF)</span>
        <span style="color:#838183; font-style:italic">// [0]xED    [1]x80-9F       [2]UTF8-tail(x80-BF)</span>
        <span style="color:#838183; font-style:italic">// [0]xEE-EF [1]UTF8-tail    [2]UTF8-tail(x80-BF)</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(((</span>octet <span style="color:#000000">==</span> <span style="color:#b07e00">0xe0</span><span style="color:#000000">) &amp;&amp; !((</span>octet1 <span style="color:#000000">&gt;=</span> <span style="color:#b07e00">0xa0</span><span style="color:#000000">) &amp;&amp; (</span>octet1 <span style="color:#000000">&lt;=</span> <span style="color:#b07e00">0xbf</span><span style="color:#000000">))) ||</span>
            <span style="color:#000000">((</span>octet <span style="color:#000000">==</span> <span style="color:#b07e00">0xed</span><span style="color:#000000">) &amp;&amp; !((</span>octet1 <span style="color:#000000">&gt;=</span> <span style="color:#b07e00">0x80</span><span style="color:#000000">) &amp;&amp; (</span>octet1 <span style="color:#000000">&lt;=</span> <span style="color:#b07e00">0x9f</span><span style="color:#000000">)))) { *</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">2</span><span style="color:#000000">;</span> <span style="color:#000000; font-weight:bold">return</span> codepoint<span style="color:#000000">; }</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>octet <span style="color:#000000">&gt;=</span> <span style="color:#b07e00">0xe0</span><span style="color:#000000">) &amp;&amp; (</span>octet <span style="color:#000000">&lt;=</span> <span style="color:#b07e00">0xef</span><span style="color:#000000">))</span>
        <span style="color:#000000">{</span>
            codepoint <span style="color:#000000">= ((</span>octet <span style="color:#000000">&amp;</span> <span style="color:#b07e00">0xf</span><span style="color:#000000">) &lt;&lt;</span> <span style="color:#b07e00">12</span><span style="color:#000000">) | ((</span>octet1 <span style="color:#000000">&amp;</span> <span style="color:#b07e00">0x3f</span><span style="color:#000000">) &lt;&lt;</span> <span style="color:#b07e00">6</span><span style="color:#000000">) | (</span>octet2 <span style="color:#000000">&amp;</span> <span style="color:#b07e00">0x3f</span><span style="color:#000000">);</span>
            <span style="color:#000000">*</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">3</span><span style="color:#000000">;</span>
        <span style="color:#000000">}</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">else if</span> <span style="color:#000000">((</span>octet <span style="color:#000000">&amp;</span> <span style="color:#b07e00">0xf8</span><span style="color:#000000">) ==</span> <span style="color:#b07e00">0xf0</span><span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#838183; font-style:italic">// Four octets</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>octet <span style="color:#000000">&gt;</span> <span style="color:#b07e00">0xf4</span><span style="color:#000000">)</span> <span style="color:#000000; font-weight:bold">return</span> codepoint<span style="color:#000000">;</span>
        <span style="color:#0057ae">unsigned char</span> octet1 <span style="color:#000000">=</span> text<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">];</span>
        <span style="color:#0057ae">unsigned char</span> octet2 <span style="color:#000000">=</span> <span style="color:#bf0303">&apos;\0&apos;</span><span style="color:#000000">;</span>
        <span style="color:#0057ae">unsigned char</span> octet3 <span style="color:#000000">=</span> <span style="color:#bf0303">&apos;\0&apos;</span><span style="color:#000000">;</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>octet1 <span style="color:#000000">==</span> <span style="color:#bf0303">&apos;\0&apos;</span><span style="color:#000000">) || ((</span>octet1 <span style="color:#000000">&gt;&gt;</span> <span style="color:#b07e00">6</span><span style="color:#000000">) !=</span> <span style="color:#b07e00">2</span><span style="color:#000000">)) { *</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">2</span><span style="color:#000000">;</span> <span style="color:#000000; font-weight:bold">return</span> codepoint<span style="color:#000000">; }</span>  <span style="color:#838183; font-style:italic">// Unexpected sequence</span>
        octet2 <span style="color:#000000">=</span> text<span style="color:#000000">[</span><span style="color:#b07e00">2</span><span style="color:#000000">];</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>octet2 <span style="color:#000000">==</span> <span style="color:#bf0303">&apos;\0&apos;</span><span style="color:#000000">) || ((</span>octet2 <span style="color:#000000">&gt;&gt;</span> <span style="color:#b07e00">6</span><span style="color:#000000">) !=</span> <span style="color:#b07e00">2</span><span style="color:#000000">)) { *</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">3</span><span style="color:#000000">;</span> <span style="color:#000000; font-weight:bold">return</span> codepoint<span style="color:#000000">; }</span>  <span style="color:#838183; font-style:italic">// Unexpected sequence</span>
        octet3 <span style="color:#000000">=</span> text<span style="color:#000000">[</span><span style="color:#b07e00">3</span><span style="color:#000000">];</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>octet3 <span style="color:#000000">==</span> <span style="color:#bf0303">&apos;\0&apos;</span><span style="color:#000000">) || ((</span>octet3 <span style="color:#000000">&gt;&gt;</span> <span style="color:#b07e00">6</span><span style="color:#000000">) !=</span> <span style="color:#b07e00">2</span><span style="color:#000000">)) { *</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">4</span><span style="color:#000000">;</span> <span style="color:#000000; font-weight:bold">return</span> codepoint<span style="color:#000000">; }</span>  <span style="color:#838183; font-style:italic">// Unexpected sequence</span>
        <span style="color:#838183; font-style:italic">// [0]xF0       [1]x90-BF       [2]UTF8-tail  [3]UTF8-tail</span>
        <span style="color:#838183; font-style:italic">// [0]xF1-F3    [1]UTF8-tail    [2]UTF8-tail  [3]UTF8-tail</span>
        <span style="color:#838183; font-style:italic">// [0]xF4       [1]x80-8F       [2]UTF8-tail  [3]UTF8-tail</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(((</span>octet <span style="color:#000000">==</span> <span style="color:#b07e00">0xf0</span><span style="color:#000000">) &amp;&amp; !((</span>octet1 <span style="color:#000000">&gt;=</span> <span style="color:#b07e00">0x90</span><span style="color:#000000">) &amp;&amp; (</span>octet1 <span style="color:#000000">&lt;=</span> <span style="color:#b07e00">0xbf</span><span style="color:#000000">))) ||</span>
            <span style="color:#000000">((</span>octet <span style="color:#000000">==</span> <span style="color:#b07e00">0xf4</span><span style="color:#000000">) &amp;&amp; !((</span>octet1 <span style="color:#000000">&gt;=</span> <span style="color:#b07e00">0x80</span><span style="color:#000000">) &amp;&amp; (</span>octet1 <span style="color:#000000">&lt;=</span> <span style="color:#b07e00">0x8f</span><span style="color:#000000">)))) { *</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">2</span><span style="color:#000000">;</span> <span style="color:#000000; font-weight:bold">return</span> codepoint<span style="color:#000000">; }</span> <span style="color:#838183; font-style:italic">// Unexpected sequence</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>octet <span style="color:#000000">&gt;=</span> <span style="color:#b07e00">0xf0</span><span style="color:#000000">)</span>
        <span style="color:#000000">{</span>
            codepoint <span style="color:#000000">= ((</span>octet <span style="color:#000000">&amp;</span> <span style="color:#b07e00">0x7</span><span style="color:#000000">) &lt;&lt;</span> <span style="color:#b07e00">18</span><span style="color:#000000">) | ((</span>octet1 <span style="color:#000000">&amp;</span> <span style="color:#b07e00">0x3f</span><span style="color:#000000">) &lt;&lt;</span> <span style="color:#b07e00">12</span><span style="color:#000000">) | ((</span>octet2 <span style="color:#000000">&amp;</span> <span style="color:#b07e00">0x3f</span><span style="color:#000000">) &lt;&lt;</span> <span style="color:#b07e00">6</span><span style="color:#000000">) | (</span>octet3 <span style="color:#000000">&amp;</span> <span style="color:#b07e00">0x3f</span><span style="color:#000000">);</span>
            <span style="color:#000000">*</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">4</span><span style="color:#000000">;</span>
        <span style="color:#000000">}</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>codepoint <span style="color:#000000">&gt;</span> <span style="color:#b07e00">0x10ffff</span><span style="color:#000000">)</span> codepoint <span style="color:#000000">=</span> <span style="color:#b07e00">0x3f</span><span style="color:#000000">;</span>     <span style="color:#838183; font-style:italic">// Codepoints after U+10ffff are invalid</span>
    <span style="color:#000000; font-weight:bold">return</span> codepoint<span style="color:#000000">;</span>
<span style="color:#000000">}</span>
