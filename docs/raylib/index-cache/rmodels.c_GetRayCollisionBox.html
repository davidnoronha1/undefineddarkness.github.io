RayCollision <span style="color:#010181">GetRayCollisionBox</span><span style="color:#000000">(</span>Ray ray<span style="color:#000000">,</span> BoundingBox box<span style="color:#000000">){</span>
    RayCollision collision <span style="color:#000000">= {</span> <span style="color:#b07e00">0</span> <span style="color:#000000">};</span>
    <span style="color:#838183; font-style:italic">// Note: If ray.position is inside the box, the distance is negative (as if the ray was reversed)</span>
    <span style="color:#838183; font-style:italic">// Reversing ray.direction will give use the correct result.</span>
    <span style="color:#0057ae">bool</span> insideBox <span style="color:#000000">= (</span>ray<span style="color:#000000">.</span>position<span style="color:#000000">.</span>x <span style="color:#000000">&gt;</span> box<span style="color:#000000">.</span>min<span style="color:#000000">.</span>x<span style="color:#000000">) &amp;&amp; (</span>ray<span style="color:#000000">.</span>position<span style="color:#000000">.</span>x <span style="color:#000000">&lt;</span> box<span style="color:#000000">.</span>max<span style="color:#000000">.</span>x<span style="color:#000000">) &amp;&amp;</span>
                     <span style="color:#000000">(</span>ray<span style="color:#000000">.</span>position<span style="color:#000000">.</span>y <span style="color:#000000">&gt;</span> box<span style="color:#000000">.</span>min<span style="color:#000000">.</span>y<span style="color:#000000">) &amp;&amp; (</span>ray<span style="color:#000000">.</span>position<span style="color:#000000">.</span>y <span style="color:#000000">&lt;</span> box<span style="color:#000000">.</span>max<span style="color:#000000">.</span>y<span style="color:#000000">) &amp;&amp;</span>
                     <span style="color:#000000">(</span>ray<span style="color:#000000">.</span>position<span style="color:#000000">.</span>z <span style="color:#000000">&gt;</span> box<span style="color:#000000">.</span>min<span style="color:#000000">.</span>z<span style="color:#000000">) &amp;&amp; (</span>ray<span style="color:#000000">.</span>position<span style="color:#000000">.</span>z <span style="color:#000000">&lt;</span> box<span style="color:#000000">.</span>max<span style="color:#000000">.</span>z<span style="color:#000000">);</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>insideBox<span style="color:#000000">)</span> ray<span style="color:#000000">.</span>direction <span style="color:#000000">=</span> <span style="color:#010181">Vector3Negate</span><span style="color:#000000">(</span>ray<span style="color:#000000">.</span>direction<span style="color:#000000">);</span>
    <span style="color:#0057ae">float</span> t<span style="color:#000000">[</span><span style="color:#b07e00">11</span><span style="color:#000000">] = {</span> <span style="color:#b07e00">0</span> <span style="color:#000000">};</span>
    t<span style="color:#000000">[</span><span style="color:#b07e00">8</span><span style="color:#000000">] =</span> <span style="color:#b07e00">1.0</span>f<span style="color:#000000">/</span>ray<span style="color:#000000">.</span>direction<span style="color:#000000">.</span>x<span style="color:#000000">;</span>
    t<span style="color:#000000">[</span><span style="color:#b07e00">9</span><span style="color:#000000">] =</span> <span style="color:#b07e00">1.0</span>f<span style="color:#000000">/</span>ray<span style="color:#000000">.</span>direction<span style="color:#000000">.</span>y<span style="color:#000000">;</span>
    t<span style="color:#000000">[</span><span style="color:#b07e00">10</span><span style="color:#000000">] =</span> <span style="color:#b07e00">1.0</span>f<span style="color:#000000">/</span>ray<span style="color:#000000">.</span>direction<span style="color:#000000">.</span>z<span style="color:#000000">;</span>
    t<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">] = (</span>box<span style="color:#000000">.</span>min<span style="color:#000000">.</span>x <span style="color:#000000">-</span> ray<span style="color:#000000">.</span>position<span style="color:#000000">.</span>x<span style="color:#000000">)*</span>t<span style="color:#000000">[</span><span style="color:#b07e00">8</span><span style="color:#000000">];</span>
    t<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">] = (</span>box<span style="color:#000000">.</span>max<span style="color:#000000">.</span>x <span style="color:#000000">-</span> ray<span style="color:#000000">.</span>position<span style="color:#000000">.</span>x<span style="color:#000000">)*</span>t<span style="color:#000000">[</span><span style="color:#b07e00">8</span><span style="color:#000000">];</span>
    t<span style="color:#000000">[</span><span style="color:#b07e00">2</span><span style="color:#000000">] = (</span>box<span style="color:#000000">.</span>min<span style="color:#000000">.</span>y <span style="color:#000000">-</span> ray<span style="color:#000000">.</span>position<span style="color:#000000">.</span>y<span style="color:#000000">)*</span>t<span style="color:#000000">[</span><span style="color:#b07e00">9</span><span style="color:#000000">];</span>
    t<span style="color:#000000">[</span><span style="color:#b07e00">3</span><span style="color:#000000">] = (</span>box<span style="color:#000000">.</span>max<span style="color:#000000">.</span>y <span style="color:#000000">-</span> ray<span style="color:#000000">.</span>position<span style="color:#000000">.</span>y<span style="color:#000000">)*</span>t<span style="color:#000000">[</span><span style="color:#b07e00">9</span><span style="color:#000000">];</span>
    t<span style="color:#000000">[</span><span style="color:#b07e00">4</span><span style="color:#000000">] = (</span>box<span style="color:#000000">.</span>min<span style="color:#000000">.</span>z <span style="color:#000000">-</span> ray<span style="color:#000000">.</span>position<span style="color:#000000">.</span>z<span style="color:#000000">)*</span>t<span style="color:#000000">[</span><span style="color:#b07e00">10</span><span style="color:#000000">];</span>
    t<span style="color:#000000">[</span><span style="color:#b07e00">5</span><span style="color:#000000">] = (</span>box<span style="color:#000000">.</span>max<span style="color:#000000">.</span>z <span style="color:#000000">-</span> ray<span style="color:#000000">.</span>position<span style="color:#000000">.</span>z<span style="color:#000000">)*</span>t<span style="color:#000000">[</span><span style="color:#b07e00">10</span><span style="color:#000000">];</span>
    t<span style="color:#000000">[</span><span style="color:#b07e00">6</span><span style="color:#000000">] = (</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span><span style="color:#010181">fmax</span><span style="color:#000000">(</span><span style="color:#010181">fmax</span><span style="color:#000000">(</span><span style="color:#010181">fmin</span><span style="color:#000000">(</span>t<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">],</span> t<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]),</span> <span style="color:#010181">fmin</span><span style="color:#000000">(</span>t<span style="color:#000000">[</span><span style="color:#b07e00">2</span><span style="color:#000000">],</span> t<span style="color:#000000">[</span><span style="color:#b07e00">3</span><span style="color:#000000">])),</span> <span style="color:#010181">fmin</span><span style="color:#000000">(</span>t<span style="color:#000000">[</span><span style="color:#b07e00">4</span><span style="color:#000000">],</span> t<span style="color:#000000">[</span><span style="color:#b07e00">5</span><span style="color:#000000">]));</span>
    t<span style="color:#000000">[</span><span style="color:#b07e00">7</span><span style="color:#000000">] = (</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span><span style="color:#010181">fmin</span><span style="color:#000000">(</span><span style="color:#010181">fmin</span><span style="color:#000000">(</span><span style="color:#010181">fmax</span><span style="color:#000000">(</span>t<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">],</span> t<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]),</span> <span style="color:#010181">fmax</span><span style="color:#000000">(</span>t<span style="color:#000000">[</span><span style="color:#b07e00">2</span><span style="color:#000000">],</span> t<span style="color:#000000">[</span><span style="color:#b07e00">3</span><span style="color:#000000">])),</span> <span style="color:#010181">fmax</span><span style="color:#000000">(</span>t<span style="color:#000000">[</span><span style="color:#b07e00">4</span><span style="color:#000000">],</span> t<span style="color:#000000">[</span><span style="color:#b07e00">5</span><span style="color:#000000">]));</span>
    collision<span style="color:#000000">.</span>hit <span style="color:#000000">= !((</span>t<span style="color:#000000">[</span><span style="color:#b07e00">7</span><span style="color:#000000">] &lt;</span> <span style="color:#b07e00">0</span><span style="color:#000000">) || (</span>t<span style="color:#000000">[</span><span style="color:#b07e00">6</span><span style="color:#000000">] &gt;</span> t<span style="color:#000000">[</span><span style="color:#b07e00">7</span><span style="color:#000000">]));</span>
    collision<span style="color:#000000">.</span>distance <span style="color:#000000">=</span> t<span style="color:#000000">[</span><span style="color:#b07e00">6</span><span style="color:#000000">];</span>
    collision<span style="color:#000000">.</span>point <span style="color:#000000">=</span> <span style="color:#010181">Vector3Add</span><span style="color:#000000">(</span>ray<span style="color:#000000">.</span>position<span style="color:#000000">,</span> <span style="color:#010181">Vector3Scale</span><span style="color:#000000">(</span>ray<span style="color:#000000">.</span>direction<span style="color:#000000">,</span> collision<span style="color:#000000">.</span>distance<span style="color:#000000">));</span>
    <span style="color:#838183; font-style:italic">// Get box center point</span>
    collision<span style="color:#000000">.</span>normal <span style="color:#000000">=</span> <span style="color:#010181">Vector3Lerp</span><span style="color:#000000">(</span>box<span style="color:#000000">.</span>min<span style="color:#000000">,</span> box<span style="color:#000000">.</span>max<span style="color:#000000">,</span> <span style="color:#b07e00">0.5</span>f<span style="color:#000000">);</span>
    <span style="color:#838183; font-style:italic">// Get vector center point-&gt;hit point</span>
    collision<span style="color:#000000">.</span>normal <span style="color:#000000">=</span> <span style="color:#010181">Vector3Subtract</span><span style="color:#000000">(</span>collision<span style="color:#000000">.</span>point<span style="color:#000000">,</span> collision<span style="color:#000000">.</span>normal<span style="color:#000000">);</span>
    <span style="color:#838183; font-style:italic">// Scale vector to unit cube</span>
    <span style="color:#838183; font-style:italic">// NOTE: We use an additional .01 to fix numerical errors</span>
    collision<span style="color:#000000">.</span>normal <span style="color:#000000">=</span> <span style="color:#010181">Vector3Scale</span><span style="color:#000000">(</span>collision<span style="color:#000000">.</span>normal<span style="color:#000000">,</span> <span style="color:#b07e00">2.01</span>f<span style="color:#000000">);</span>
    collision<span style="color:#000000">.</span>normal <span style="color:#000000">=</span> <span style="color:#010181">Vector3Divide</span><span style="color:#000000">(</span>collision<span style="color:#000000">.</span>normal<span style="color:#000000">,</span> <span style="color:#010181">Vector3Subtract</span><span style="color:#000000">(</span>box<span style="color:#000000">.</span>max<span style="color:#000000">,</span> box<span style="color:#000000">.</span>min<span style="color:#000000">));</span>
    <span style="color:#838183; font-style:italic">// The relevant elements of the vector are now slightly larger than 1.0f (or smaller than -1.0f)</span>
    <span style="color:#838183; font-style:italic">// and the others are somewhere between -1.0 and 1.0 casting to int is exactly our wanted normal!</span>
    collision<span style="color:#000000">.</span>normal<span style="color:#000000">.</span>x <span style="color:#000000">= (</span><span style="color:#0057ae">float</span><span style="color:#000000">)((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>collision<span style="color:#000000">.</span>normal<span style="color:#000000">.</span>x<span style="color:#000000">);</span>
    collision<span style="color:#000000">.</span>normal<span style="color:#000000">.</span>y <span style="color:#000000">= (</span><span style="color:#0057ae">float</span><span style="color:#000000">)((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>collision<span style="color:#000000">.</span>normal<span style="color:#000000">.</span>y<span style="color:#000000">);</span>
    collision<span style="color:#000000">.</span>normal<span style="color:#000000">.</span>z <span style="color:#000000">= (</span><span style="color:#0057ae">float</span><span style="color:#000000">)((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>collision<span style="color:#000000">.</span>normal<span style="color:#000000">.</span>z<span style="color:#000000">);</span>
    collision<span style="color:#000000">.</span>normal <span style="color:#000000">=</span> <span style="color:#010181">Vector3Normalize</span><span style="color:#000000">(</span>collision<span style="color:#000000">.</span>normal<span style="color:#000000">);</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>insideBox<span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#838183; font-style:italic">// Reset ray.direction</span>
        ray<span style="color:#000000">.</span>direction <span style="color:#000000">=</span> <span style="color:#010181">Vector3Negate</span><span style="color:#000000">(</span>ray<span style="color:#000000">.</span>direction<span style="color:#000000">);</span>
        <span style="color:#838183; font-style:italic">// Fix result</span>
        collision<span style="color:#000000">.</span>distance <span style="color:#000000">*= -</span><span style="color:#b07e00">1.0</span>f<span style="color:#000000">;</span>
        collision<span style="color:#000000">.</span>normal <span style="color:#000000">=</span> <span style="color:#010181">Vector3Negate</span><span style="color:#000000">(</span>collision<span style="color:#000000">.</span>normal<span style="color:#000000">);</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">return</span> collision<span style="color:#000000">;</span>
<span style="color:#000000">}</span>
