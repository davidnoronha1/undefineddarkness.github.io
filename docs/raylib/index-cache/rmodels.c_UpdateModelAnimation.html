<span style="color:#0057ae">void</span> <span style="color:#010181">UpdateModelAnimation</span><span style="color:#000000">(</span>Model model<span style="color:#000000">,</span> ModelAnimation anim<span style="color:#000000">,</span> <span style="color:#0057ae">int</span> frame<span style="color:#000000">){</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>anim<span style="color:#000000">.</span>frameCount <span style="color:#000000">&gt;</span> <span style="color:#b07e00">0</span><span style="color:#000000">) &amp;&amp; (</span>anim<span style="color:#000000">.</span>bones <span style="color:#000000">!=</span> NULL<span style="color:#000000">) &amp;&amp; (</span>anim<span style="color:#000000">.</span>framePoses <span style="color:#000000">!=</span> NULL<span style="color:#000000">))</span>
    <span style="color:#000000">{</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>frame <span style="color:#000000">&gt;=</span> anim<span style="color:#000000">.</span>frameCount<span style="color:#000000">)</span> frame <span style="color:#000000">=</span> frame<span style="color:#000000">%</span>anim<span style="color:#000000">.</span>frameCount<span style="color:#000000">;</span>
        <span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span><span style="color:#0057ae">int</span> m <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span> m <span style="color:#000000">&lt;</span> model<span style="color:#000000">.</span>meshCount<span style="color:#000000">;</span> m<span style="color:#000000">++)</span>
        <span style="color:#000000">{</span>
            Mesh mesh <span style="color:#000000">=</span> model<span style="color:#000000">.</span>meshes<span style="color:#000000">[</span>m<span style="color:#000000">];</span>
            <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>boneIds <span style="color:#000000">==</span> NULL <span style="color:#000000">||</span> mesh<span style="color:#000000">.</span>boneWeights <span style="color:#000000">==</span> NULL<span style="color:#000000">)</span>
            <span style="color:#000000">{</span>
                <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_WARNING<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;MODEL: UpdateModelAnimation(): Mesh %i has no connection to bones&quot;</span><span style="color:#000000">,</span> m<span style="color:#000000">);</span>
                <span style="color:#000000; font-weight:bold">continue</span><span style="color:#000000">;</span>
            <span style="color:#000000">}</span>
            <span style="color:#0057ae">bool</span> updated <span style="color:#000000">=</span> <span style="color:#000000; font-weight:bold">false</span><span style="color:#000000">;</span>           <span style="color:#838183; font-style:italic">// Flag to check when anim vertex information is updated</span>
            Vector3 animVertex <span style="color:#000000">= {</span> <span style="color:#b07e00">0</span> <span style="color:#000000">};</span>
            Vector3 animNormal <span style="color:#000000">= {</span> <span style="color:#b07e00">0</span> <span style="color:#000000">};</span>
            Vector3 inTranslation <span style="color:#000000">= {</span> <span style="color:#b07e00">0</span> <span style="color:#000000">};</span>
            Quaternion inRotation <span style="color:#000000">= {</span> <span style="color:#b07e00">0</span> <span style="color:#000000">};</span>
            <span style="color:#838183; font-style:italic">// Vector3 inScale = { 0 };</span>
            Vector3 outTranslation <span style="color:#000000">= {</span> <span style="color:#b07e00">0</span> <span style="color:#000000">};</span>
            Quaternion outRotation <span style="color:#000000">= {</span> <span style="color:#b07e00">0</span> <span style="color:#000000">};</span>
            Vector3 outScale <span style="color:#000000">= {</span> <span style="color:#b07e00">0</span> <span style="color:#000000">};</span>
            <span style="color:#0057ae">int</span> boneId <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span>
            <span style="color:#0057ae">int</span> boneCounter <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span>
            <span style="color:#0057ae">float</span> boneWeight <span style="color:#000000">=</span> <span style="color:#b07e00">0.0</span><span style="color:#000000">;</span>
            <span style="color:#0057ae">const int</span> vValues <span style="color:#000000">=</span> mesh<span style="color:#000000">.</span>vertexCount<span style="color:#000000">*</span><span style="color:#b07e00">3</span><span style="color:#000000">;</span>
            <span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span><span style="color:#0057ae">int</span> vCounter <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span> vCounter <span style="color:#000000">&lt;</span> vValues<span style="color:#000000">;</span> vCounter <span style="color:#000000">+=</span> <span style="color:#b07e00">3</span><span style="color:#000000">)</span>
            <span style="color:#000000">{</span>
                mesh<span style="color:#000000">.</span>animVertices<span style="color:#000000">[</span>vCounter<span style="color:#000000">] =</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span>
                mesh<span style="color:#000000">.</span>animVertices<span style="color:#000000">[</span>vCounter <span style="color:#000000">+</span> <span style="color:#b07e00">1</span><span style="color:#000000">] =</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span>
                mesh<span style="color:#000000">.</span>animVertices<span style="color:#000000">[</span>vCounter <span style="color:#000000">+</span> <span style="color:#b07e00">2</span><span style="color:#000000">] =</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span>
                <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>animNormals <span style="color:#000000">!=</span> NULL<span style="color:#000000">)</span>
                <span style="color:#000000">{</span>
                    mesh<span style="color:#000000">.</span>animNormals<span style="color:#000000">[</span>vCounter<span style="color:#000000">] =</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span>
                    mesh<span style="color:#000000">.</span>animNormals<span style="color:#000000">[</span>vCounter <span style="color:#000000">+</span> <span style="color:#b07e00">1</span><span style="color:#000000">] =</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span>
                    mesh<span style="color:#000000">.</span>animNormals<span style="color:#000000">[</span>vCounter <span style="color:#000000">+</span> <span style="color:#b07e00">2</span><span style="color:#000000">] =</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span>
                <span style="color:#000000">}</span>
                <span style="color:#838183; font-style:italic">// Iterates over 4 bones per vertex</span>
                <span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span><span style="color:#0057ae">int</span> j <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span> j <span style="color:#000000">&lt;</span> <span style="color:#b07e00">4</span><span style="color:#000000">;</span> j<span style="color:#000000">++,</span> boneCounter<span style="color:#000000">++)</span>
                <span style="color:#000000">{</span>
                    boneWeight <span style="color:#000000">=</span> mesh<span style="color:#000000">.</span>boneWeights<span style="color:#000000">[</span>boneCounter<span style="color:#000000">];</span>
                    <span style="color:#838183; font-style:italic">// Early stop when no transformation will be applied</span>
                    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>boneWeight <span style="color:#000000">==</span> <span style="color:#b07e00">0.0</span>f<span style="color:#000000">)</span> <span style="color:#000000; font-weight:bold">continue</span><span style="color:#000000">;</span>
                    boneId <span style="color:#000000">=</span> mesh<span style="color:#000000">.</span>boneIds<span style="color:#000000">[</span>boneCounter<span style="color:#000000">];</span>
                    <span style="color:#838183; font-style:italic">//int boneIdParent = model.bones[boneId].parent;</span>
                    inTranslation <span style="color:#000000">=</span> model<span style="color:#000000">.</span>bindPose<span style="color:#000000">[</span>boneId<span style="color:#000000">].</span>translation<span style="color:#000000">;</span>
                    inRotation <span style="color:#000000">=</span> model<span style="color:#000000">.</span>bindPose<span style="color:#000000">[</span>boneId<span style="color:#000000">].</span>rotation<span style="color:#000000">;</span>
                    <span style="color:#838183; font-style:italic">//inScale = model.bindPose[boneId].scale;</span>
                    outTranslation <span style="color:#000000">=</span> anim<span style="color:#000000">.</span>framePoses<span style="color:#000000">[</span>frame<span style="color:#000000">][</span>boneId<span style="color:#000000">].</span>translation<span style="color:#000000">;</span>
                    outRotation <span style="color:#000000">=</span> anim<span style="color:#000000">.</span>framePoses<span style="color:#000000">[</span>frame<span style="color:#000000">][</span>boneId<span style="color:#000000">].</span>rotation<span style="color:#000000">;</span>
                    outScale <span style="color:#000000">=</span> anim<span style="color:#000000">.</span>framePoses<span style="color:#000000">[</span>frame<span style="color:#000000">][</span>boneId<span style="color:#000000">].</span>scale<span style="color:#000000">;</span>
                    <span style="color:#838183; font-style:italic">// Vertices processing</span>
                    <span style="color:#838183; font-style:italic">// NOTE: We use meshes.vertices (default vertex position) to calculate meshes.animVertices (animated vertex position)</span>
                    animVertex <span style="color:#000000">= (</span>Vector3<span style="color:#000000">){</span> mesh<span style="color:#000000">.</span>vertices<span style="color:#000000">[</span>vCounter<span style="color:#000000">],</span> mesh<span style="color:#000000">.</span>vertices<span style="color:#000000">[</span>vCounter <span style="color:#000000">+</span> <span style="color:#b07e00">1</span><span style="color:#000000">],</span> mesh<span style="color:#000000">.</span>vertices<span style="color:#000000">[</span>vCounter <span style="color:#000000">+</span> <span style="color:#b07e00">2</span><span style="color:#000000">] };</span>
                    animVertex <span style="color:#000000">=</span> <span style="color:#010181">Vector3Subtract</span><span style="color:#000000">(</span>animVertex<span style="color:#000000">,</span> inTranslation<span style="color:#000000">);</span>
                    animVertex <span style="color:#000000">=</span> <span style="color:#010181">Vector3Multiply</span><span style="color:#000000">(</span>animVertex<span style="color:#000000">,</span> outScale<span style="color:#000000">);</span>
                    animVertex <span style="color:#000000">=</span> <span style="color:#010181">Vector3RotateByQuaternion</span><span style="color:#000000">(</span>animVertex<span style="color:#000000">,</span> <span style="color:#010181">QuaternionMultiply</span><span style="color:#000000">(</span>outRotation<span style="color:#000000">,</span> <span style="color:#010181">QuaternionInvert</span><span style="color:#000000">(</span>inRotation<span style="color:#000000">)));</span>
                    animVertex <span style="color:#000000">=</span> <span style="color:#010181">Vector3Add</span><span style="color:#000000">(</span>animVertex<span style="color:#000000">,</span> outTranslation<span style="color:#000000">);</span>
                    <span style="color:#838183; font-style:italic">//animVertex = Vector3Transform(animVertex, model.transform);</span>
                    mesh<span style="color:#000000">.</span>animVertices<span style="color:#000000">[</span>vCounter<span style="color:#000000">] +=</span> animVertex<span style="color:#000000">.</span>x<span style="color:#000000">*</span>boneWeight<span style="color:#000000">;</span>
                    mesh<span style="color:#000000">.</span>animVertices<span style="color:#000000">[</span>vCounter <span style="color:#000000">+</span> <span style="color:#b07e00">1</span><span style="color:#000000">] +=</span> animVertex<span style="color:#000000">.</span>y<span style="color:#000000">*</span>boneWeight<span style="color:#000000">;</span>
                    mesh<span style="color:#000000">.</span>animVertices<span style="color:#000000">[</span>vCounter <span style="color:#000000">+</span> <span style="color:#b07e00">2</span><span style="color:#000000">] +=</span> animVertex<span style="color:#000000">.</span>z<span style="color:#000000">*</span>boneWeight<span style="color:#000000">;</span>
                    updated <span style="color:#000000">=</span> <span style="color:#000000; font-weight:bold">true</span><span style="color:#000000">;</span>
                    <span style="color:#838183; font-style:italic">// Normals processing</span>
                    <span style="color:#838183; font-style:italic">// NOTE: We use meshes.baseNormals (default normal) to calculate meshes.normals (animated normals)</span>
                    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>normals <span style="color:#000000">!=</span> NULL<span style="color:#000000">)</span>
                    <span style="color:#000000">{</span>
                        animNormal <span style="color:#000000">= (</span>Vector3<span style="color:#000000">){</span> mesh<span style="color:#000000">.</span>normals<span style="color:#000000">[</span>vCounter<span style="color:#000000">],</span> mesh<span style="color:#000000">.</span>normals<span style="color:#000000">[</span>vCounter <span style="color:#000000">+</span> <span style="color:#b07e00">1</span><span style="color:#000000">],</span> mesh<span style="color:#000000">.</span>normals<span style="color:#000000">[</span>vCounter <span style="color:#000000">+</span> <span style="color:#b07e00">2</span><span style="color:#000000">] };</span>
                        animNormal <span style="color:#000000">=</span> <span style="color:#010181">Vector3RotateByQuaternion</span><span style="color:#000000">(</span>animNormal<span style="color:#000000">,</span> <span style="color:#010181">QuaternionMultiply</span><span style="color:#000000">(</span>outRotation<span style="color:#000000">,</span> <span style="color:#010181">QuaternionInvert</span><span style="color:#000000">(</span>inRotation<span style="color:#000000">)));</span>
                        mesh<span style="color:#000000">.</span>animNormals<span style="color:#000000">[</span>vCounter<span style="color:#000000">] +=</span> animNormal<span style="color:#000000">.</span>x<span style="color:#000000">*</span>boneWeight<span style="color:#000000">;</span>
                        mesh<span style="color:#000000">.</span>animNormals<span style="color:#000000">[</span>vCounter <span style="color:#000000">+</span> <span style="color:#b07e00">1</span><span style="color:#000000">] +=</span> animNormal<span style="color:#000000">.</span>y<span style="color:#000000">*</span>boneWeight<span style="color:#000000">;</span>
                        mesh<span style="color:#000000">.</span>animNormals<span style="color:#000000">[</span>vCounter <span style="color:#000000">+</span> <span style="color:#b07e00">2</span><span style="color:#000000">] +=</span> animNormal<span style="color:#000000">.</span>z<span style="color:#000000">*</span>boneWeight<span style="color:#000000">;</span>
                    <span style="color:#000000">}</span>
                <span style="color:#000000">}</span>
            <span style="color:#000000">}</span>
            <span style="color:#838183; font-style:italic">// Upload new vertex data to GPU for model drawing</span>
            <span style="color:#838183; font-style:italic">// NOTE: Only update data when values changed</span>
            <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>updated<span style="color:#000000">)</span>
            <span style="color:#000000">{</span>
                <span style="color:#010181">rlUpdateVertexBuffer</span><span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>vboId<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">],</span> mesh<span style="color:#000000">.</span>animVertices<span style="color:#000000">,</span> mesh<span style="color:#000000">.</span>vertexCount<span style="color:#000000">*</span><span style="color:#b07e00">3</span><span style="color:#000000">*</span><span style="color:#000000; font-weight:bold">sizeof</span><span style="color:#000000">(</span><span style="color:#0057ae">float</span><span style="color:#000000">),</span> <span style="color:#b07e00">0</span><span style="color:#000000">);</span> <span style="color:#838183; font-style:italic">// Update vertex position</span>
                <span style="color:#010181">rlUpdateVertexBuffer</span><span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>vboId<span style="color:#000000">[</span><span style="color:#b07e00">2</span><span style="color:#000000">],</span> mesh<span style="color:#000000">.</span>animNormals<span style="color:#000000">,</span> mesh<span style="color:#000000">.</span>vertexCount<span style="color:#000000">*</span><span style="color:#b07e00">3</span><span style="color:#000000">*</span><span style="color:#000000; font-weight:bold">sizeof</span><span style="color:#000000">(</span><span style="color:#0057ae">float</span><span style="color:#000000">),</span> <span style="color:#b07e00">0</span><span style="color:#000000">);</span>  <span style="color:#838183; font-style:italic">// Update vertex normals</span>
            <span style="color:#000000">}</span>
        <span style="color:#000000">}</span>
    <span style="color:#000000">}</span>
<span style="color:#000000">}</span>
