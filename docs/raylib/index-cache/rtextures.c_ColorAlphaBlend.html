Color <span style="color:#010181">ColorAlphaBlend</span><span style="color:#000000">(</span>Color dst<span style="color:#000000">,</span> Color src<span style="color:#000000">,</span> Color tint<span style="color:#000000">){</span>
    Color out <span style="color:#000000">=</span> WHITE<span style="color:#000000">;</span>
    <span style="color:#838183; font-style:italic">// Apply color tint to source color</span>
    src<span style="color:#000000">.</span>r <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned char</span><span style="color:#000000">)(((</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>src<span style="color:#000000">.</span>r<span style="color:#000000">*((</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>tint<span style="color:#000000">.</span>r<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)) &gt;&gt;</span> <span style="color:#b07e00">8</span><span style="color:#000000">);</span>
    src<span style="color:#000000">.</span>g <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned char</span><span style="color:#000000">)(((</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>src<span style="color:#000000">.</span>g<span style="color:#000000">*((</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>tint<span style="color:#000000">.</span>g<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)) &gt;&gt;</span> <span style="color:#b07e00">8</span><span style="color:#000000">);</span>
    src<span style="color:#000000">.</span>b <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned char</span><span style="color:#000000">)(((</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>src<span style="color:#000000">.</span>b<span style="color:#000000">*((</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>tint<span style="color:#000000">.</span>b<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)) &gt;&gt;</span> <span style="color:#b07e00">8</span><span style="color:#000000">);</span>
    src<span style="color:#000000">.</span>a <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned char</span><span style="color:#000000">)(((</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>src<span style="color:#000000">.</span>a<span style="color:#000000">*((</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>tint<span style="color:#000000">.</span>a<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)) &gt;&gt;</span> <span style="color:#b07e00">8</span><span style="color:#000000">);</span>
<span style="color:#838183; font-style:italic">//#define COLORALPHABLEND_FLOAT</span>
<span style="color:#008200">#define COLORALPHABLEND_INTEGERS</span>
<span style="color:#008200">#if defined(COLORALPHABLEND_INTEGERS)</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>src<span style="color:#000000">.</span>a <span style="color:#000000">==</span> <span style="color:#b07e00">0</span><span style="color:#000000">)</span> out <span style="color:#000000">=</span> dst<span style="color:#000000">;</span>
    <span style="color:#000000; font-weight:bold">else if</span> <span style="color:#000000">(</span>src<span style="color:#000000">.</span>a <span style="color:#000000">==</span> <span style="color:#b07e00">255</span><span style="color:#000000">)</span> out <span style="color:#000000">=</span> src<span style="color:#000000">;</span>
    <span style="color:#000000; font-weight:bold">else</span>
    <span style="color:#000000">{</span>
        <span style="color:#0057ae">unsigned int</span> alpha <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>src<span style="color:#000000">.</span>a <span style="color:#000000">+</span> <span style="color:#b07e00">1</span><span style="color:#000000">;</span>     <span style="color:#838183; font-style:italic">// We are shifting by 8 (dividing by 256), so we need to take that excess into account</span>
        out<span style="color:#000000">.</span>a <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned char</span><span style="color:#000000">)(((</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>alpha<span style="color:#000000">*</span><span style="color:#b07e00">256</span> <span style="color:#000000">+ (</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>dst<span style="color:#000000">.</span>a<span style="color:#000000">*(</span><span style="color:#b07e00">256</span> <span style="color:#000000">-</span> alpha<span style="color:#000000">)) &gt;&gt;</span> <span style="color:#b07e00">8</span><span style="color:#000000">);</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>out<span style="color:#000000">.</span>a <span style="color:#000000">&gt;</span> <span style="color:#b07e00">0</span><span style="color:#000000">)</span>
        <span style="color:#000000">{</span>
            out<span style="color:#000000">.</span>r <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned char</span><span style="color:#000000">)((((</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>src<span style="color:#000000">.</span>r<span style="color:#000000">*</span>alpha<span style="color:#000000">*</span><span style="color:#b07e00">256</span> <span style="color:#000000">+ (</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>dst<span style="color:#000000">.</span>r<span style="color:#000000">*(</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>dst<span style="color:#000000">.</span>a<span style="color:#000000">*(</span><span style="color:#b07e00">256</span> <span style="color:#000000">-</span> alpha<span style="color:#000000">))/</span>out<span style="color:#000000">.</span>a<span style="color:#000000">) &gt;&gt;</span> <span style="color:#b07e00">8</span><span style="color:#000000">);</span>
            out<span style="color:#000000">.</span>g <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned char</span><span style="color:#000000">)((((</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>src<span style="color:#000000">.</span>g<span style="color:#000000">*</span>alpha<span style="color:#000000">*</span><span style="color:#b07e00">256</span> <span style="color:#000000">+ (</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>dst<span style="color:#000000">.</span>g<span style="color:#000000">*(</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>dst<span style="color:#000000">.</span>a<span style="color:#000000">*(</span><span style="color:#b07e00">256</span> <span style="color:#000000">-</span> alpha<span style="color:#000000">))/</span>out<span style="color:#000000">.</span>a<span style="color:#000000">) &gt;&gt;</span> <span style="color:#b07e00">8</span><span style="color:#000000">);</span>
            out<span style="color:#000000">.</span>b <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned char</span><span style="color:#000000">)((((</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>src<span style="color:#000000">.</span>b<span style="color:#000000">*</span>alpha<span style="color:#000000">*</span><span style="color:#b07e00">256</span> <span style="color:#000000">+ (</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>dst<span style="color:#000000">.</span>b<span style="color:#000000">*(</span><span style="color:#0057ae">unsigned int</span><span style="color:#000000">)</span>dst<span style="color:#000000">.</span>a<span style="color:#000000">*(</span><span style="color:#b07e00">256</span> <span style="color:#000000">-</span> alpha<span style="color:#000000">))/</span>out<span style="color:#000000">.</span>a<span style="color:#000000">) &gt;&gt;</span> <span style="color:#b07e00">8</span><span style="color:#000000">);</span>
        <span style="color:#000000">}</span>
    <span style="color:#000000">}</span>
<span style="color:#008200">#endif</span>
<span style="color:#008200">#if defined(COLORALPHABLEND_FLOAT)</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>src<span style="color:#000000">.</span>a <span style="color:#000000">==</span> <span style="color:#b07e00">0</span><span style="color:#000000">)</span> out <span style="color:#000000">=</span> dst<span style="color:#000000">;</span>
    <span style="color:#000000; font-weight:bold">else if</span> <span style="color:#000000">(</span>src<span style="color:#000000">.</span>a <span style="color:#000000">==</span> <span style="color:#b07e00">255</span><span style="color:#000000">)</span> out <span style="color:#000000">=</span> src<span style="color:#000000">;</span>
    <span style="color:#000000; font-weight:bold">else</span>
    <span style="color:#000000">{</span>
        Vector4 fdst <span style="color:#000000">=</span> <span style="color:#010181">ColorNormalize</span><span style="color:#000000">(</span>dst<span style="color:#000000">);</span>
        Vector4 fsrc <span style="color:#000000">=</span> <span style="color:#010181">ColorNormalize</span><span style="color:#000000">(</span>src<span style="color:#000000">);</span>
        Vector4 ftint <span style="color:#000000">=</span> <span style="color:#010181">ColorNormalize</span><span style="color:#000000">(</span>tint<span style="color:#000000">);</span>
        Vector4 fout <span style="color:#000000">= {</span> <span style="color:#b07e00">0</span> <span style="color:#000000">};</span>
        fout<span style="color:#000000">.</span>w <span style="color:#000000">=</span> fsrc<span style="color:#000000">.</span>w <span style="color:#000000">+</span> fdst<span style="color:#000000">.</span>w<span style="color:#000000">*(</span><span style="color:#b07e00">1.0</span>f <span style="color:#000000">-</span> fsrc<span style="color:#000000">.</span>w<span style="color:#000000">);</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>fout<span style="color:#000000">.</span>w <span style="color:#000000">&gt;</span> <span style="color:#b07e00">0.0</span>f<span style="color:#000000">)</span>
        <span style="color:#000000">{</span>
            fout<span style="color:#000000">.</span>x <span style="color:#000000">= (</span>fsrc<span style="color:#000000">.</span>x<span style="color:#000000">*</span>fsrc<span style="color:#000000">.</span>w <span style="color:#000000">+</span> fdst<span style="color:#000000">.</span>x<span style="color:#000000">*</span>fdst<span style="color:#000000">.</span>w<span style="color:#000000">*(</span><span style="color:#b07e00">1</span> <span style="color:#000000">-</span> fsrc<span style="color:#000000">.</span>w<span style="color:#000000">))/</span>fout<span style="color:#000000">.</span>w<span style="color:#000000">;</span>
            fout<span style="color:#000000">.</span>y <span style="color:#000000">= (</span>fsrc<span style="color:#000000">.</span>y<span style="color:#000000">*</span>fsrc<span style="color:#000000">.</span>w <span style="color:#000000">+</span> fdst<span style="color:#000000">.</span>y<span style="color:#000000">*</span>fdst<span style="color:#000000">.</span>w<span style="color:#000000">*(</span><span style="color:#b07e00">1</span> <span style="color:#000000">-</span> fsrc<span style="color:#000000">.</span>w<span style="color:#000000">))/</span>fout<span style="color:#000000">.</span>w<span style="color:#000000">;</span>
            fout<span style="color:#000000">.</span>z <span style="color:#000000">= (</span>fsrc<span style="color:#000000">.</span>z<span style="color:#000000">*</span>fsrc<span style="color:#000000">.</span>w <span style="color:#000000">+</span> fdst<span style="color:#000000">.</span>z<span style="color:#000000">*</span>fdst<span style="color:#000000">.</span>w<span style="color:#000000">*(</span><span style="color:#b07e00">1</span> <span style="color:#000000">-</span> fsrc<span style="color:#000000">.</span>w<span style="color:#000000">))/</span>fout<span style="color:#000000">.</span>w<span style="color:#000000">;</span>
        <span style="color:#000000">}</span>
        out <span style="color:#000000">= (</span>Color<span style="color:#000000">){ (</span><span style="color:#0057ae">unsigned char</span><span style="color:#000000">)(</span>fout<span style="color:#000000">.</span>x<span style="color:#000000">*</span><span style="color:#b07e00">255.0</span>f<span style="color:#000000">), (</span><span style="color:#0057ae">unsigned char</span><span style="color:#000000">)(</span>fout<span style="color:#000000">.</span>y<span style="color:#000000">*</span><span style="color:#b07e00">255.0</span>f<span style="color:#000000">), (</span><span style="color:#0057ae">unsigned char</span><span style="color:#000000">)(</span>fout<span style="color:#000000">.</span>z<span style="color:#000000">*</span><span style="color:#b07e00">255.0</span>f<span style="color:#000000">), (</span><span style="color:#0057ae">unsigned char</span><span style="color:#000000">)(</span>fout<span style="color:#000000">.</span>w<span style="color:#000000">*</span><span style="color:#b07e00">255.0</span>f<span style="color:#000000">) };</span>
    <span style="color:#000000">}</span>
<span style="color:#008200">#endif</span>
    <span style="color:#000000; font-weight:bold">return</span> out<span style="color:#000000">;</span>
<span style="color:#000000">}</span>
