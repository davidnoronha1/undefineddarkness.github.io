<span style="color:#0057ae">int</span> <span style="color:#010181">GetCodepointNext</span><span style="color:#000000">(</span><span style="color:#0057ae">const char</span> <span style="color:#000000">*</span>text<span style="color:#000000">,</span> <span style="color:#0057ae">int</span> <span style="color:#000000">*</span>codepointSize<span style="color:#000000">){</span>
    <span style="color:#0057ae">const char</span> <span style="color:#000000">*</span>ptr <span style="color:#000000">=</span> text<span style="color:#000000">;</span>
    <span style="color:#0057ae">int</span> codepoint <span style="color:#000000">=</span> <span style="color:#b07e00">0x3f</span><span style="color:#000000">;</span>       <span style="color:#838183; font-style:italic">// Codepoint (defaults to &apos;?&apos;)</span>
    <span style="color:#000000">*</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">1</span><span style="color:#000000">;</span>
    <span style="color:#838183; font-style:italic">// Get current codepoint and bytes processed</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span><span style="color:#b07e00">0xf0</span> <span style="color:#000000">== (</span><span style="color:#b07e00">0xf8</span> <span style="color:#000000">&amp;</span> ptr<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">]))</span>
    <span style="color:#000000">{</span>
        <span style="color:#838183; font-style:italic">// 4 byte UTF-8 codepoint</span>
        <span style="color:#000000; font-weight:bold">if</span><span style="color:#000000">(((</span>ptr<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">] &amp;</span> <span style="color:#b07e00">0xC0</span><span style="color:#000000">) ^</span> <span style="color:#b07e00">0x80</span><span style="color:#000000">) || ((</span>ptr<span style="color:#000000">[</span><span style="color:#b07e00">2</span><span style="color:#000000">] &amp;</span> <span style="color:#b07e00">0xC0</span><span style="color:#000000">) ^</span> <span style="color:#b07e00">0x80</span><span style="color:#000000">) || ((</span>ptr<span style="color:#000000">[</span><span style="color:#b07e00">3</span><span style="color:#000000">] &amp;</span> <span style="color:#b07e00">0xC0</span><span style="color:#000000">) ^</span> <span style="color:#b07e00">0x80</span><span style="color:#000000">)) {</span> <span style="color:#000000; font-weight:bold">return</span> codepoint<span style="color:#000000">; }</span> <span style="color:#838183; font-style:italic">//10xxxxxx checks</span>
        codepoint <span style="color:#000000">= ((</span><span style="color:#b07e00">0x07</span> <span style="color:#000000">&amp;</span> ptr<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">]) &lt;&lt;</span> <span style="color:#b07e00">18</span><span style="color:#000000">) | ((</span><span style="color:#b07e00">0x3f</span> <span style="color:#000000">&amp;</span> ptr<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]) &lt;&lt;</span> <span style="color:#b07e00">12</span><span style="color:#000000">) | ((</span><span style="color:#b07e00">0x3f</span> <span style="color:#000000">&amp;</span> ptr<span style="color:#000000">[</span><span style="color:#b07e00">2</span><span style="color:#000000">]) &lt;&lt;</span> <span style="color:#b07e00">6</span><span style="color:#000000">) | (</span><span style="color:#b07e00">0x3f</span> <span style="color:#000000">&amp;</span> ptr<span style="color:#000000">[</span><span style="color:#b07e00">3</span><span style="color:#000000">]);</span>
        <span style="color:#000000">*</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">4</span><span style="color:#000000">;</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">else if</span> <span style="color:#000000">(</span><span style="color:#b07e00">0xe0</span> <span style="color:#000000">== (</span><span style="color:#b07e00">0xf0</span> <span style="color:#000000">&amp;</span> ptr<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">]))</span>
    <span style="color:#000000">{</span>
        <span style="color:#838183; font-style:italic">// 3 byte UTF-8 codepoint */</span>
        <span style="color:#000000; font-weight:bold">if</span><span style="color:#000000">(((</span>ptr<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">] &amp;</span> <span style="color:#b07e00">0xC0</span><span style="color:#000000">) ^</span> <span style="color:#b07e00">0x80</span><span style="color:#000000">) || ((</span>ptr<span style="color:#000000">[</span><span style="color:#b07e00">2</span><span style="color:#000000">] &amp;</span> <span style="color:#b07e00">0xC0</span><span style="color:#000000">) ^</span> <span style="color:#b07e00">0x80</span><span style="color:#000000">)) {</span> <span style="color:#000000; font-weight:bold">return</span> codepoint<span style="color:#000000">; }</span> <span style="color:#838183; font-style:italic">//10xxxxxx checks</span>
        codepoint <span style="color:#000000">= ((</span><span style="color:#b07e00">0x0f</span> <span style="color:#000000">&amp;</span> ptr<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">]) &lt;&lt;</span> <span style="color:#b07e00">12</span><span style="color:#000000">) | ((</span><span style="color:#b07e00">0x3f</span> <span style="color:#000000">&amp;</span> ptr<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]) &lt;&lt;</span> <span style="color:#b07e00">6</span><span style="color:#000000">) | (</span><span style="color:#b07e00">0x3f</span> <span style="color:#000000">&amp;</span> ptr<span style="color:#000000">[</span><span style="color:#b07e00">2</span><span style="color:#000000">]);</span>
        <span style="color:#000000">*</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">3</span><span style="color:#000000">;</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">else if</span> <span style="color:#000000">(</span><span style="color:#b07e00">0xc0</span> <span style="color:#000000">== (</span><span style="color:#b07e00">0xe0</span> <span style="color:#000000">&amp;</span> ptr<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">]))</span>
    <span style="color:#000000">{</span>
        <span style="color:#838183; font-style:italic">// 2 byte UTF-8 codepoint</span>
        <span style="color:#000000; font-weight:bold">if</span><span style="color:#000000">((</span>ptr<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">] &amp;</span> <span style="color:#b07e00">0xC0</span><span style="color:#000000">) ^</span> <span style="color:#b07e00">0x80</span><span style="color:#000000">) {</span> <span style="color:#000000; font-weight:bold">return</span> codepoint<span style="color:#000000">; }</span> <span style="color:#838183; font-style:italic">//10xxxxxx checks</span>
        codepoint <span style="color:#000000">= ((</span><span style="color:#b07e00">0x1f</span> <span style="color:#000000">&amp;</span> ptr<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">]) &lt;&lt;</span> <span style="color:#b07e00">6</span><span style="color:#000000">) | (</span><span style="color:#b07e00">0x3f</span> <span style="color:#000000">&amp;</span> ptr<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]);</span>
        <span style="color:#000000">*</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">2</span><span style="color:#000000">;</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">else if</span> <span style="color:#000000">(</span><span style="color:#b07e00">0x00</span> <span style="color:#000000">== (</span><span style="color:#b07e00">0x80</span> <span style="color:#000000">&amp;</span> ptr<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">]))</span>
    <span style="color:#000000">{</span>
        <span style="color:#838183; font-style:italic">// 1 byte UTF-8 codepoint</span>
        codepoint <span style="color:#000000">=</span> ptr<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">];</span>
        <span style="color:#000000">*</span>codepointSize <span style="color:#000000">=</span> <span style="color:#b07e00">1</span><span style="color:#000000">;</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">return</span> codepoint<span style="color:#000000">;</span>
<span style="color:#000000">}</span>
