<span style="color:#0057ae">float</span> <span style="color:#010181">GetMusicTimePlayed</span><span style="color:#000000">(</span>Music music<span style="color:#000000">){</span>
    <span style="color:#0057ae">float</span> secondsPlayed <span style="color:#000000">=</span> <span style="color:#b07e00">0.0</span>f<span style="color:#000000">;</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>music<span style="color:#000000">.</span>stream<span style="color:#000000">.</span>buffer <span style="color:#000000">!=</span> NULL<span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
<span style="color:#008200">#if defined(SUPPORT_FILEFORMAT_XM)</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>music<span style="color:#000000">.</span>ctxType <span style="color:#000000">==</span> MUSIC_MODULE_XM<span style="color:#000000">)</span>
        <span style="color:#000000">{</span>
            <span style="color:#0057ae">uint64_t</span> framesPlayed <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span>
            <span style="color:#010181">jar_xm_get_position</span><span style="color:#000000">(</span>music<span style="color:#000000">.</span>ctxData<span style="color:#000000">,</span> NULL<span style="color:#000000">,</span> NULL<span style="color:#000000">,</span> NULL<span style="color:#000000">, &amp;</span>framesPlayed<span style="color:#000000">);</span>
            secondsPlayed <span style="color:#000000">= (</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>framesPlayed<span style="color:#000000">/</span>music<span style="color:#000000">.</span>stream<span style="color:#000000">.</span>sampleRate<span style="color:#000000">;</span>
        <span style="color:#000000">}</span>
        <span style="color:#000000; font-weight:bold">else</span>
<span style="color:#008200">#endif</span>
        <span style="color:#000000">{</span>
            <span style="color:#838183; font-style:italic">//ma_uint32 frameSizeInBytes = ma_get_bytes_per_sample(music.stream.buffer-&gt;dsp.formatConverterIn.config.formatIn)*music.stream.buffer-&gt;dsp.formatConverterIn.config.channels;</span>
            <span style="color:#0057ae">int</span> framesProcessed <span style="color:#000000">= (</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>music<span style="color:#000000">.</span>stream<span style="color:#000000">.</span>buffer<span style="color:#000000">-&gt;</span>framesProcessed<span style="color:#000000">;</span>
            <span style="color:#0057ae">int</span> subBufferSize <span style="color:#000000">= (</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>music<span style="color:#000000">.</span>stream<span style="color:#000000">.</span>buffer<span style="color:#000000">-&gt;</span>sizeInFrames<span style="color:#000000">/</span><span style="color:#b07e00">2</span><span style="color:#000000">;</span>
            <span style="color:#0057ae">int</span> framesInFirstBuffer <span style="color:#000000">=</span> music<span style="color:#000000">.</span>stream<span style="color:#000000">.</span>buffer<span style="color:#000000">-&gt;</span>isSubBufferProcessed<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">]?</span> <span style="color:#b07e00">0</span> <span style="color:#000000">:</span> subBufferSize<span style="color:#000000">;</span>
            <span style="color:#0057ae">int</span> framesInSecondBuffer <span style="color:#000000">=</span> music<span style="color:#000000">.</span>stream<span style="color:#000000">.</span>buffer<span style="color:#000000">-&gt;</span>isSubBufferProcessed<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]?</span> <span style="color:#b07e00">0</span> <span style="color:#000000">:</span> subBufferSize<span style="color:#000000">;</span>
            <span style="color:#0057ae">int</span> framesSentToMix <span style="color:#000000">=</span> music<span style="color:#000000">.</span>stream<span style="color:#000000">.</span>buffer<span style="color:#000000">-&gt;</span>frameCursorPos<span style="color:#000000">%</span>subBufferSize<span style="color:#000000">;</span>
            <span style="color:#0057ae">int</span> framesPlayed <span style="color:#000000">= (</span>framesProcessed <span style="color:#000000">-</span> framesInFirstBuffer <span style="color:#000000">-</span> framesInSecondBuffer <span style="color:#000000">+</span> framesSentToMix<span style="color:#000000">)%(</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>music<span style="color:#000000">.</span>frameCount<span style="color:#000000">;</span>
            <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>framesPlayed <span style="color:#000000">&lt;</span> <span style="color:#b07e00">0</span><span style="color:#000000">)</span> framesPlayed <span style="color:#000000">+=</span> music<span style="color:#000000">.</span>frameCount<span style="color:#000000">;</span>
            secondsPlayed <span style="color:#000000">= (</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>framesPlayed<span style="color:#000000">/</span>music<span style="color:#000000">.</span>stream<span style="color:#000000">.</span>sampleRate<span style="color:#000000">;</span>
        <span style="color:#000000">}</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">return</span> secondsPlayed<span style="color:#000000">;</span>
<span style="color:#000000">}</span>
