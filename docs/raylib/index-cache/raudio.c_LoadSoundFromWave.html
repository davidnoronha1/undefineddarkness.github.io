Sound <span style="color:#010181">LoadSoundFromWave</span><span style="color:#000000">(</span>Wave wave<span style="color:#000000">){</span>
    Sound sound <span style="color:#000000">= {</span> <span style="color:#b07e00">0</span> <span style="color:#000000">};</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>wave<span style="color:#000000">.</span>data <span style="color:#000000">!=</span> NULL<span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#838183; font-style:italic">// When using miniaudio we need to do our own mixing.</span>
        <span style="color:#838183; font-style:italic">// To simplify this we need convert the format of each sound to be consistent with</span>
        <span style="color:#838183; font-style:italic">// the format used to open the playback AUDIO.System.device. We can do this two ways:</span>
        <span style="color:#838183; font-style:italic">//</span>
        <span style="color:#838183; font-style:italic">//   1) Convert the whole sound in one go at load time (here).</span>
        <span style="color:#838183; font-style:italic">//   2) Convert the audio data in chunks at mixing time.</span>
        <span style="color:#838183; font-style:italic">//</span>
        <span style="color:#838183; font-style:italic">// First option has been selected, format conversion is done on the loading stage.</span>
        <span style="color:#838183; font-style:italic">// The downside is that it uses more memory if the original sound is u8 or s16.</span>
        ma_format formatIn <span style="color:#000000">= ((</span>wave<span style="color:#000000">.</span>sampleSize <span style="color:#000000">==</span> <span style="color:#b07e00">8</span><span style="color:#000000">)?</span> ma_format_u8 <span style="color:#000000">: ((</span>wave<span style="color:#000000">.</span>sampleSize <span style="color:#000000">==</span> <span style="color:#b07e00">16</span><span style="color:#000000">)?</span> ma_format_s16 <span style="color:#000000">:</span> ma_format_f32<span style="color:#000000">));</span>
        ma_uint32 frameCountIn <span style="color:#000000">=</span> wave<span style="color:#000000">.</span>frameCount<span style="color:#000000">;</span>
        ma_uint32 frameCount <span style="color:#000000">= (</span>ma_uint32<span style="color:#000000">)</span><span style="color:#010181">ma_convert_frames</span><span style="color:#000000">(</span>NULL<span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> AUDIO_DEVICE_FORMAT<span style="color:#000000">,</span> AUDIO_DEVICE_CHANNELS<span style="color:#000000">,</span> AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>device<span style="color:#000000">.</span>sampleRate<span style="color:#000000">,</span> NULL<span style="color:#000000">,</span> frameCountIn<span style="color:#000000">,</span> formatIn<span style="color:#000000">,</span> wave<span style="color:#000000">.</span>channels<span style="color:#000000">,</span> wave<span style="color:#000000">.</span>sampleRate<span style="color:#000000">);</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>frameCount <span style="color:#000000">==</span> <span style="color:#b07e00">0</span><span style="color:#000000">)</span> <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_WARNING<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;SOUND: Failed to get frame count for format conversion&quot;</span><span style="color:#000000">);</span>
        AudioBuffer <span style="color:#000000">*</span>audioBuffer <span style="color:#000000">=</span> <span style="color:#010181">LoadAudioBuffer</span><span style="color:#000000">(</span>AUDIO_DEVICE_FORMAT<span style="color:#000000">,</span> AUDIO_DEVICE_CHANNELS<span style="color:#000000">,</span> AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>device<span style="color:#000000">.</span>sampleRate<span style="color:#000000">,</span> frameCount<span style="color:#000000">,</span> AUDIO_BUFFER_USAGE_STATIC<span style="color:#000000">);</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>audioBuffer <span style="color:#000000">==</span> NULL<span style="color:#000000">)</span>
        <span style="color:#000000">{</span>
            <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_WARNING<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;SOUND: Failed to create buffer&quot;</span><span style="color:#000000">);</span>
            <span style="color:#000000; font-weight:bold">return</span> sound<span style="color:#000000">;</span> <span style="color:#838183; font-style:italic">// early return to avoid dereferencing the audioBuffer null pointer</span>
        <span style="color:#000000">}</span>
        frameCount <span style="color:#000000">= (</span>ma_uint32<span style="color:#000000">)</span><span style="color:#010181">ma_convert_frames</span><span style="color:#000000">(</span>audioBuffer<span style="color:#000000">-&gt;</span>data<span style="color:#000000">,</span> frameCount<span style="color:#000000">,</span> AUDIO_DEVICE_FORMAT<span style="color:#000000">,</span> AUDIO_DEVICE_CHANNELS<span style="color:#000000">,</span> AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>device<span style="color:#000000">.</span>sampleRate<span style="color:#000000">,</span> wave<span style="color:#000000">.</span>data<span style="color:#000000">,</span> frameCountIn<span style="color:#000000">,</span> formatIn<span style="color:#000000">,</span> wave<span style="color:#000000">.</span>channels<span style="color:#000000">,</span> wave<span style="color:#000000">.</span>sampleRate<span style="color:#000000">);</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>frameCount <span style="color:#000000">==</span> <span style="color:#b07e00">0</span><span style="color:#000000">)</span> <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_WARNING<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;SOUND: Failed format conversion&quot;</span><span style="color:#000000">);</span>
        sound<span style="color:#000000">.</span>frameCount <span style="color:#000000">=</span> frameCount<span style="color:#000000">;</span>
        sound<span style="color:#000000">.</span>stream<span style="color:#000000">.</span>sampleRate <span style="color:#000000">=</span> AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>device<span style="color:#000000">.</span>sampleRate<span style="color:#000000">;</span>
        sound<span style="color:#000000">.</span>stream<span style="color:#000000">.</span>sampleSize <span style="color:#000000">=</span> <span style="color:#b07e00">32</span><span style="color:#000000">;</span>
        sound<span style="color:#000000">.</span>stream<span style="color:#000000">.</span>channels <span style="color:#000000">=</span> AUDIO_DEVICE_CHANNELS<span style="color:#000000">;</span>
        sound<span style="color:#000000">.</span>stream<span style="color:#000000">.</span>buffer <span style="color:#000000">=</span> audioBuffer<span style="color:#000000">;</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">return</span> sound<span style="color:#000000">;</span>
<span style="color:#000000">}</span>
