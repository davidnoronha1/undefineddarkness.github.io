<span style="color:#0057ae">void</span> <span style="color:#010181">DrawMeshInstanced</span><span style="color:#000000">(</span>Mesh mesh<span style="color:#000000">,</span> Material material<span style="color:#000000">,</span> <span style="color:#0057ae">const</span> Matrix <span style="color:#000000">*</span>transforms<span style="color:#000000">,</span> <span style="color:#0057ae">int</span> instances<span style="color:#000000">){</span>
<span style="color:#008200">#if defined(GRAPHICS_API_OPENGL_33) || defined(GRAPHICS_API_OPENGL_ES2)</span>
    <span style="color:#838183; font-style:italic">// Instancing required variables</span>
    float16 <span style="color:#000000">*</span>instanceTransforms <span style="color:#000000">=</span> NULL<span style="color:#000000">;</span>
    <span style="color:#0057ae">unsigned int</span> instancesVboId <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span>
    <span style="color:#838183; font-style:italic">// Bind shader program</span>
    <span style="color:#010181">rlEnableShader</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>id<span style="color:#000000">);</span>
    <span style="color:#838183; font-style:italic">// Send required data to shader (matrices, values)</span>
    <span style="color:#838183; font-style:italic">//-----------------------------------------------------</span>
    <span style="color:#838183; font-style:italic">// Upload to shader material.colDiffuse</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_COLOR_DIFFUSE<span style="color:#000000">] != -</span><span style="color:#b07e00">1</span><span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#0057ae">float</span> values<span style="color:#000000">[</span><span style="color:#b07e00">4</span><span style="color:#000000">] = {</span>
            <span style="color:#000000">(</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>material<span style="color:#000000">.</span>maps<span style="color:#000000">[</span>MATERIAL_MAP_DIFFUSE<span style="color:#000000">].</span>color<span style="color:#000000">.</span>r<span style="color:#000000">/</span><span style="color:#b07e00">255.0</span>f<span style="color:#000000">,</span>
            <span style="color:#000000">(</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>material<span style="color:#000000">.</span>maps<span style="color:#000000">[</span>MATERIAL_MAP_DIFFUSE<span style="color:#000000">].</span>color<span style="color:#000000">.</span>g<span style="color:#000000">/</span><span style="color:#b07e00">255.0</span>f<span style="color:#000000">,</span>
            <span style="color:#000000">(</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>material<span style="color:#000000">.</span>maps<span style="color:#000000">[</span>MATERIAL_MAP_DIFFUSE<span style="color:#000000">].</span>color<span style="color:#000000">.</span>b<span style="color:#000000">/</span><span style="color:#b07e00">255.0</span>f<span style="color:#000000">,</span>
            <span style="color:#000000">(</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>material<span style="color:#000000">.</span>maps<span style="color:#000000">[</span>MATERIAL_MAP_DIFFUSE<span style="color:#000000">].</span>color<span style="color:#000000">.</span>a<span style="color:#000000">/</span><span style="color:#b07e00">255.0</span>f
        <span style="color:#000000">};</span>
        <span style="color:#010181">rlSetUniform</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_COLOR_DIFFUSE<span style="color:#000000">],</span> values<span style="color:#000000">,</span> SHADER_UNIFORM_VEC4<span style="color:#000000">,</span> <span style="color:#b07e00">1</span><span style="color:#000000">);</span>
    <span style="color:#000000">}</span>
    <span style="color:#838183; font-style:italic">// Upload to shader material.colSpecular (if location available)</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_COLOR_SPECULAR<span style="color:#000000">] != -</span><span style="color:#b07e00">1</span><span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#0057ae">float</span> values<span style="color:#000000">[</span><span style="color:#b07e00">4</span><span style="color:#000000">] = {</span>
            <span style="color:#000000">(</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>material<span style="color:#000000">.</span>maps<span style="color:#000000">[</span>SHADER_LOC_COLOR_SPECULAR<span style="color:#000000">].</span>color<span style="color:#000000">.</span>r<span style="color:#000000">/</span><span style="color:#b07e00">255.0</span>f<span style="color:#000000">,</span>
            <span style="color:#000000">(</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>material<span style="color:#000000">.</span>maps<span style="color:#000000">[</span>SHADER_LOC_COLOR_SPECULAR<span style="color:#000000">].</span>color<span style="color:#000000">.</span>g<span style="color:#000000">/</span><span style="color:#b07e00">255.0</span>f<span style="color:#000000">,</span>
            <span style="color:#000000">(</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>material<span style="color:#000000">.</span>maps<span style="color:#000000">[</span>SHADER_LOC_COLOR_SPECULAR<span style="color:#000000">].</span>color<span style="color:#000000">.</span>b<span style="color:#000000">/</span><span style="color:#b07e00">255.0</span>f<span style="color:#000000">,</span>
            <span style="color:#000000">(</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>material<span style="color:#000000">.</span>maps<span style="color:#000000">[</span>SHADER_LOC_COLOR_SPECULAR<span style="color:#000000">].</span>color<span style="color:#000000">.</span>a<span style="color:#000000">/</span><span style="color:#b07e00">255.0</span>f
        <span style="color:#000000">};</span>
        <span style="color:#010181">rlSetUniform</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_COLOR_SPECULAR<span style="color:#000000">],</span> values<span style="color:#000000">,</span> SHADER_UNIFORM_VEC4<span style="color:#000000">,</span> <span style="color:#b07e00">1</span><span style="color:#000000">);</span>
    <span style="color:#000000">}</span>
    <span style="color:#838183; font-style:italic">// Get a copy of current matrices to work with,</span>
    <span style="color:#838183; font-style:italic">// just in case stereo render is required, and we need to modify them</span>
    <span style="color:#838183; font-style:italic">// NOTE: At this point the modelview matrix just contains the view matrix (camera)</span>
    <span style="color:#838183; font-style:italic">// That&apos;s because BeginMode3D() sets it and there is no model-drawing function</span>
    <span style="color:#838183; font-style:italic">// that modifies it, all use rlPushMatrix() and rlPopMatrix()</span>
    Matrix matModel <span style="color:#000000">=</span> <span style="color:#010181">MatrixIdentity</span><span style="color:#000000">();</span>
    Matrix matView <span style="color:#000000">=</span> <span style="color:#010181">rlGetMatrixModelview</span><span style="color:#000000">();</span>
    Matrix matModelView <span style="color:#000000">=</span> <span style="color:#010181">MatrixIdentity</span><span style="color:#000000">();</span>
    Matrix matProjection <span style="color:#000000">=</span> <span style="color:#010181">rlGetMatrixProjection</span><span style="color:#000000">();</span>
    <span style="color:#838183; font-style:italic">// Upload view and projection matrices (if locations available)</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_MATRIX_VIEW<span style="color:#000000">] != -</span><span style="color:#b07e00">1</span><span style="color:#000000">)</span> <span style="color:#010181">rlSetUniformMatrix</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_MATRIX_VIEW<span style="color:#000000">],</span> matView<span style="color:#000000">);</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_MATRIX_PROJECTION<span style="color:#000000">] != -</span><span style="color:#b07e00">1</span><span style="color:#000000">)</span> <span style="color:#010181">rlSetUniformMatrix</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_MATRIX_PROJECTION<span style="color:#000000">],</span> matProjection<span style="color:#000000">);</span>
    <span style="color:#838183; font-style:italic">// Create instances buffer</span>
    instanceTransforms <span style="color:#000000">= (</span>float16 <span style="color:#000000">*)</span><span style="color:#010181">RL_MALLOC</span><span style="color:#000000">(</span>instances<span style="color:#000000">*</span><span style="color:#000000; font-weight:bold">sizeof</span><span style="color:#000000">(</span>float16<span style="color:#000000">));</span>
    <span style="color:#838183; font-style:italic">// Fill buffer with instances transformations as float16 arrays</span>
    <span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span><span style="color:#0057ae">int</span> i <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span> i <span style="color:#000000">&lt;</span> instances<span style="color:#000000">;</span> i<span style="color:#000000">++)</span> instanceTransforms<span style="color:#000000">[</span>i<span style="color:#000000">] =</span> <span style="color:#010181">MatrixToFloatV</span><span style="color:#000000">(</span>transforms<span style="color:#000000">[</span>i<span style="color:#000000">]);</span>
    <span style="color:#838183; font-style:italic">// Enable mesh VAO to attach new buffer</span>
    <span style="color:#010181">rlEnableVertexArray</span><span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>vaoId<span style="color:#000000">);</span>
    <span style="color:#838183; font-style:italic">// This could alternatively use a static VBO and either glMapBuffer() or glBufferSubData().</span>
    <span style="color:#838183; font-style:italic">// It isn&apos;t clear which would be reliably faster in all cases and on all platforms,</span>
    <span style="color:#838183; font-style:italic">// anecdotally glMapBuffer() seems very slow (syncs) while glBufferSubData() seems</span>
    <span style="color:#838183; font-style:italic">// no faster, since we&apos;re transferring all the transform matrices anyway</span>
    instancesVboId <span style="color:#000000">=</span> <span style="color:#010181">rlLoadVertexBuffer</span><span style="color:#000000">(</span>instanceTransforms<span style="color:#000000">,</span> instances<span style="color:#000000">*</span><span style="color:#000000; font-weight:bold">sizeof</span><span style="color:#000000">(</span>float16<span style="color:#000000">),</span> <span style="color:#000000; font-weight:bold">false</span><span style="color:#000000">);</span>
    <span style="color:#838183; font-style:italic">// Instances transformation matrices are send to shader attribute location: SHADER_LOC_MATRIX_MODEL</span>
    <span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span><span style="color:#0057ae">unsigned int</span> i <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span> i <span style="color:#000000">&lt;</span> <span style="color:#b07e00">4</span><span style="color:#000000">;</span> i<span style="color:#000000">++)</span>
    <span style="color:#000000">{</span>
        <span style="color:#010181">rlEnableVertexAttribute</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_MATRIX_MODEL<span style="color:#000000">] +</span> i<span style="color:#000000">);</span>
        <span style="color:#010181">rlSetVertexAttribute</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_MATRIX_MODEL<span style="color:#000000">] +</span> i<span style="color:#000000">,</span> <span style="color:#b07e00">4</span><span style="color:#000000">,</span> RL_FLOAT<span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> <span style="color:#000000; font-weight:bold">sizeof</span><span style="color:#000000">(</span>Matrix<span style="color:#000000">), (</span><span style="color:#0057ae">void</span> <span style="color:#000000">*)(</span>i<span style="color:#000000">*</span><span style="color:#000000; font-weight:bold">sizeof</span><span style="color:#000000">(</span>Vector4<span style="color:#000000">)));</span>
        <span style="color:#010181">rlSetVertexAttributeDivisor</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_MATRIX_MODEL<span style="color:#000000">] +</span> i<span style="color:#000000">,</span> <span style="color:#b07e00">1</span><span style="color:#000000">);</span>
    <span style="color:#000000">}</span>
    <span style="color:#010181">rlDisableVertexBuffer</span><span style="color:#000000">();</span>
    <span style="color:#010181">rlDisableVertexArray</span><span style="color:#000000">();</span>
    <span style="color:#838183; font-style:italic">// Accumulate internal matrix transform (push/pop) and view matrix</span>
    <span style="color:#838183; font-style:italic">// NOTE: In this case, model instance transformation must be computed in the shader</span>
    matModelView <span style="color:#000000">=</span> <span style="color:#010181">MatrixMultiply</span><span style="color:#000000">(</span><span style="color:#010181">rlGetMatrixTransform</span><span style="color:#000000">(),</span> matView<span style="color:#000000">);</span>
    <span style="color:#838183; font-style:italic">// Upload model normal matrix (if locations available)</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_MATRIX_NORMAL<span style="color:#000000">] != -</span><span style="color:#b07e00">1</span><span style="color:#000000">)</span> <span style="color:#010181">rlSetUniformMatrix</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_MATRIX_NORMAL<span style="color:#000000">],</span> <span style="color:#010181">MatrixTranspose</span><span style="color:#000000">(</span><span style="color:#010181">MatrixInvert</span><span style="color:#000000">(</span>matModel<span style="color:#000000">)));</span>
    <span style="color:#838183; font-style:italic">//-----------------------------------------------------</span>
    <span style="color:#838183; font-style:italic">// Bind active texture maps (if available)</span>
    <span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span><span style="color:#0057ae">int</span> i <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span> i <span style="color:#000000">&lt;</span> MAX_MATERIAL_MAPS<span style="color:#000000">;</span> i<span style="color:#000000">++)</span>
    <span style="color:#000000">{</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>material<span style="color:#000000">.</span>maps<span style="color:#000000">[</span>i<span style="color:#000000">].</span>texture<span style="color:#000000">.</span>id <span style="color:#000000">&gt;</span> <span style="color:#b07e00">0</span><span style="color:#000000">)</span>
        <span style="color:#000000">{</span>
            <span style="color:#838183; font-style:italic">// Select current shader texture slot</span>
            <span style="color:#010181">rlActiveTextureSlot</span><span style="color:#000000">(</span>i<span style="color:#000000">);</span>
            <span style="color:#838183; font-style:italic">// Enable texture for active slot</span>
            <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>i <span style="color:#000000">==</span> MATERIAL_MAP_IRRADIANCE<span style="color:#000000">) ||</span>
                <span style="color:#000000">(</span>i <span style="color:#000000">==</span> MATERIAL_MAP_PREFILTER<span style="color:#000000">) ||</span>
                <span style="color:#000000">(</span>i <span style="color:#000000">==</span> MATERIAL_MAP_CUBEMAP<span style="color:#000000">))</span> <span style="color:#010181">rlEnableTextureCubemap</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>maps<span style="color:#000000">[</span>i<span style="color:#000000">].</span>texture<span style="color:#000000">.</span>id<span style="color:#000000">);</span>
            <span style="color:#000000; font-weight:bold">else</span> <span style="color:#010181">rlEnableTexture</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>maps<span style="color:#000000">[</span>i<span style="color:#000000">].</span>texture<span style="color:#000000">.</span>id<span style="color:#000000">);</span>
            <span style="color:#010181">rlSetUniform</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_MAP_DIFFUSE <span style="color:#000000">+</span> i<span style="color:#000000">], &amp;</span>i<span style="color:#000000">,</span> SHADER_UNIFORM_INT<span style="color:#000000">,</span> <span style="color:#b07e00">1</span><span style="color:#000000">);</span>
        <span style="color:#000000">}</span>
    <span style="color:#000000">}</span>
    <span style="color:#838183; font-style:italic">// Try binding vertex array objects (VAO)</span>
    <span style="color:#838183; font-style:italic">// or use VBOs if not possible</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(!</span><span style="color:#010181">rlEnableVertexArray</span><span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>vaoId<span style="color:#000000">))</span>
    <span style="color:#000000">{</span>
        <span style="color:#838183; font-style:italic">// Bind mesh VBO data: vertex position (shader-location = 0)</span>
        <span style="color:#010181">rlEnableVertexBuffer</span><span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>vboId<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">]);</span>
        <span style="color:#010181">rlSetVertexAttribute</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_POSITION<span style="color:#000000">],</span> <span style="color:#b07e00">3</span><span style="color:#000000">,</span> RL_FLOAT<span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">);</span>
        <span style="color:#010181">rlEnableVertexAttribute</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_POSITION<span style="color:#000000">]);</span>
        <span style="color:#838183; font-style:italic">// Bind mesh VBO data: vertex texcoords (shader-location = 1)</span>
        <span style="color:#010181">rlEnableVertexBuffer</span><span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>vboId<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]);</span>
        <span style="color:#010181">rlSetVertexAttribute</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_TEXCOORD01<span style="color:#000000">],</span> <span style="color:#b07e00">2</span><span style="color:#000000">,</span> RL_FLOAT<span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">);</span>
        <span style="color:#010181">rlEnableVertexAttribute</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_TEXCOORD01<span style="color:#000000">]);</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_NORMAL<span style="color:#000000">] != -</span><span style="color:#b07e00">1</span><span style="color:#000000">)</span>
        <span style="color:#000000">{</span>
            <span style="color:#838183; font-style:italic">// Bind mesh VBO data: vertex normals (shader-location = 2)</span>
            <span style="color:#010181">rlEnableVertexBuffer</span><span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>vboId<span style="color:#000000">[</span><span style="color:#b07e00">2</span><span style="color:#000000">]);</span>
            <span style="color:#010181">rlSetVertexAttribute</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_NORMAL<span style="color:#000000">],</span> <span style="color:#b07e00">3</span><span style="color:#000000">,</span> RL_FLOAT<span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">);</span>
            <span style="color:#010181">rlEnableVertexAttribute</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_NORMAL<span style="color:#000000">]);</span>
        <span style="color:#000000">}</span>
        <span style="color:#838183; font-style:italic">// Bind mesh VBO data: vertex colors (shader-location = 3, if available)</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_COLOR<span style="color:#000000">] != -</span><span style="color:#b07e00">1</span><span style="color:#000000">)</span>
        <span style="color:#000000">{</span>
            <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>vboId<span style="color:#000000">[</span><span style="color:#b07e00">3</span><span style="color:#000000">] !=</span> <span style="color:#b07e00">0</span><span style="color:#000000">)</span>
            <span style="color:#000000">{</span>
                <span style="color:#010181">rlEnableVertexBuffer</span><span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>vboId<span style="color:#000000">[</span><span style="color:#b07e00">3</span><span style="color:#000000">]);</span>
                <span style="color:#010181">rlSetVertexAttribute</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_COLOR<span style="color:#000000">],</span> <span style="color:#b07e00">4</span><span style="color:#000000">,</span> RL_UNSIGNED_BYTE<span style="color:#000000">,</span> <span style="color:#b07e00">1</span><span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">);</span>
                <span style="color:#010181">rlEnableVertexAttribute</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_COLOR<span style="color:#000000">]);</span>
            <span style="color:#000000">}</span>
            <span style="color:#000000; font-weight:bold">else</span>
            <span style="color:#000000">{</span>
                <span style="color:#838183; font-style:italic">// Set default value for unused attribute</span>
                <span style="color:#838183; font-style:italic">// NOTE: Required when using default shader and no VAO support</span>
                <span style="color:#0057ae">float</span> value<span style="color:#000000">[</span><span style="color:#b07e00">4</span><span style="color:#000000">] = {</span> <span style="color:#b07e00">1.0</span>f<span style="color:#000000">,</span> <span style="color:#b07e00">1.0</span>f<span style="color:#000000">,</span> <span style="color:#b07e00">1.0</span>f<span style="color:#000000">,</span> <span style="color:#b07e00">1.0</span>f <span style="color:#000000">};</span>
                <span style="color:#010181">rlSetVertexAttributeDefault</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_COLOR<span style="color:#000000">],</span> value<span style="color:#000000">,</span> SHADER_ATTRIB_VEC4<span style="color:#000000">,</span> <span style="color:#b07e00">4</span><span style="color:#000000">);</span>
                <span style="color:#010181">rlDisableVertexAttribute</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_COLOR<span style="color:#000000">]);</span>
            <span style="color:#000000">}</span>
        <span style="color:#000000">}</span>
        <span style="color:#838183; font-style:italic">// Bind mesh VBO data: vertex tangents (shader-location = 4, if available)</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_TANGENT<span style="color:#000000">] != -</span><span style="color:#b07e00">1</span><span style="color:#000000">)</span>
        <span style="color:#000000">{</span>
            <span style="color:#010181">rlEnableVertexBuffer</span><span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>vboId<span style="color:#000000">[</span><span style="color:#b07e00">4</span><span style="color:#000000">]);</span>
            <span style="color:#010181">rlSetVertexAttribute</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_TANGENT<span style="color:#000000">],</span> <span style="color:#b07e00">4</span><span style="color:#000000">,</span> RL_FLOAT<span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">);</span>
            <span style="color:#010181">rlEnableVertexAttribute</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_TANGENT<span style="color:#000000">]);</span>
        <span style="color:#000000">}</span>
        <span style="color:#838183; font-style:italic">// Bind mesh VBO data: vertex texcoords2 (shader-location = 5, if available)</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_TEXCOORD02<span style="color:#000000">] != -</span><span style="color:#b07e00">1</span><span style="color:#000000">)</span>
        <span style="color:#000000">{</span>
            <span style="color:#010181">rlEnableVertexBuffer</span><span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>vboId<span style="color:#000000">[</span><span style="color:#b07e00">5</span><span style="color:#000000">]);</span>
            <span style="color:#010181">rlSetVertexAttribute</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_TEXCOORD02<span style="color:#000000">],</span> <span style="color:#b07e00">2</span><span style="color:#000000">,</span> RL_FLOAT<span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">);</span>
            <span style="color:#010181">rlEnableVertexAttribute</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_TEXCOORD02<span style="color:#000000">]);</span>
        <span style="color:#000000">}</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>indices <span style="color:#000000">!=</span> NULL<span style="color:#000000">)</span> <span style="color:#010181">rlEnableVertexBufferElement</span><span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>vboId<span style="color:#000000">[</span><span style="color:#b07e00">6</span><span style="color:#000000">]);</span>
    <span style="color:#000000">}</span>
    <span style="color:#838183; font-style:italic">// WARNING: Disable vertex attribute color input if mesh can not provide that data (despite location being enabled in shader)</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>vboId<span style="color:#000000">[</span><span style="color:#b07e00">3</span><span style="color:#000000">] ==</span> <span style="color:#b07e00">0</span><span style="color:#000000">)</span> <span style="color:#010181">rlDisableVertexAttribute</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_VERTEX_COLOR<span style="color:#000000">]);</span>
    <span style="color:#0057ae">int</span> eyeCount <span style="color:#000000">=</span> <span style="color:#b07e00">1</span><span style="color:#000000">;</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span><span style="color:#010181">rlIsStereoRenderEnabled</span><span style="color:#000000">())</span> eyeCount <span style="color:#000000">=</span> <span style="color:#b07e00">2</span><span style="color:#000000">;</span>
    <span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span><span style="color:#0057ae">int</span> eye <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span> eye <span style="color:#000000">&lt;</span> eyeCount<span style="color:#000000">;</span> eye<span style="color:#000000">++)</span>
    <span style="color:#000000">{</span>
        <span style="color:#838183; font-style:italic">// Calculate model-view-projection matrix (MVP)</span>
        Matrix matModelViewProjection <span style="color:#000000">=</span> <span style="color:#010181">MatrixIdentity</span><span style="color:#000000">();</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>eyeCount <span style="color:#000000">==</span> <span style="color:#b07e00">1</span><span style="color:#000000">)</span> matModelViewProjection <span style="color:#000000">=</span> <span style="color:#010181">MatrixMultiply</span><span style="color:#000000">(</span>matModelView<span style="color:#000000">,</span> matProjection<span style="color:#000000">);</span>
        <span style="color:#000000; font-weight:bold">else</span>
        <span style="color:#000000">{</span>
            <span style="color:#838183; font-style:italic">// Setup current eye viewport (half screen width)</span>
            <span style="color:#010181">rlViewport</span><span style="color:#000000">(</span>eye<span style="color:#000000">*</span><span style="color:#010181">rlGetFramebufferWidth</span><span style="color:#000000">()/</span><span style="color:#b07e00">2</span><span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> <span style="color:#010181">rlGetFramebufferWidth</span><span style="color:#000000">()/</span><span style="color:#b07e00">2</span><span style="color:#000000">,</span> <span style="color:#010181">rlGetFramebufferHeight</span><span style="color:#000000">());</span>
            matModelViewProjection <span style="color:#000000">=</span> <span style="color:#010181">MatrixMultiply</span><span style="color:#000000">(</span><span style="color:#010181">MatrixMultiply</span><span style="color:#000000">(</span>matModelView<span style="color:#000000">,</span> <span style="color:#010181">rlGetMatrixViewOffsetStereo</span><span style="color:#000000">(</span>eye<span style="color:#000000">)),</span> <span style="color:#010181">rlGetMatrixProjectionStereo</span><span style="color:#000000">(</span>eye<span style="color:#000000">));</span>
        <span style="color:#000000">}</span>
        <span style="color:#838183; font-style:italic">// Send combined model-view-projection matrix to shader</span>
        <span style="color:#010181">rlSetUniformMatrix</span><span style="color:#000000">(</span>material<span style="color:#000000">.</span>shader<span style="color:#000000">.</span>locs<span style="color:#000000">[</span>SHADER_LOC_MATRIX_MVP<span style="color:#000000">],</span> matModelViewProjection<span style="color:#000000">);</span>
        <span style="color:#838183; font-style:italic">// Draw mesh instanced</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>mesh<span style="color:#000000">.</span>indices <span style="color:#000000">!=</span> NULL<span style="color:#000000">)</span> <span style="color:#010181">rlDrawVertexArrayElementsInstanced</span><span style="color:#000000">(</span><span style="color:#b07e00">0</span><span style="color:#000000">,</span> mesh<span style="color:#000000">.</span>triangleCount<span style="color:#000000">*</span><span style="color:#b07e00">3</span><span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> instances<span style="color:#000000">);</span>
        <span style="color:#000000; font-weight:bold">else</span> <span style="color:#010181">rlDrawVertexArrayInstanced</span><span style="color:#000000">(</span><span style="color:#b07e00">0</span><span style="color:#000000">,</span> mesh<span style="color:#000000">.</span>vertexCount<span style="color:#000000">,</span> instances<span style="color:#000000">);</span>
    <span style="color:#000000">}</span>
    <span style="color:#838183; font-style:italic">// Unbind all bound texture maps</span>
    <span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span><span style="color:#0057ae">int</span> i <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span> i <span style="color:#000000">&lt;</span> MAX_MATERIAL_MAPS<span style="color:#000000">;</span> i<span style="color:#000000">++)</span>
    <span style="color:#000000">{</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>material<span style="color:#000000">.</span>maps<span style="color:#000000">[</span>i<span style="color:#000000">].</span>texture<span style="color:#000000">.</span>id <span style="color:#000000">&gt;</span> <span style="color:#b07e00">0</span><span style="color:#000000">)</span>
        <span style="color:#000000">{</span>
            <span style="color:#838183; font-style:italic">// Select current shader texture slot</span>
            <span style="color:#010181">rlActiveTextureSlot</span><span style="color:#000000">(</span>i<span style="color:#000000">);</span>
            <span style="color:#838183; font-style:italic">// Disable texture for active slot</span>
            <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>i <span style="color:#000000">==</span> MATERIAL_MAP_IRRADIANCE<span style="color:#000000">) ||</span>
                <span style="color:#000000">(</span>i <span style="color:#000000">==</span> MATERIAL_MAP_PREFILTER<span style="color:#000000">) ||</span>
                <span style="color:#000000">(</span>i <span style="color:#000000">==</span> MATERIAL_MAP_CUBEMAP<span style="color:#000000">))</span> <span style="color:#010181">rlDisableTextureCubemap</span><span style="color:#000000">();</span>
            <span style="color:#000000; font-weight:bold">else</span> <span style="color:#010181">rlDisableTexture</span><span style="color:#000000">();</span>
        <span style="color:#000000">}</span>
    <span style="color:#000000">}</span>
    <span style="color:#838183; font-style:italic">// Disable all possible vertex array objects (or VBOs)</span>
    <span style="color:#010181">rlDisableVertexArray</span><span style="color:#000000">();</span>
    <span style="color:#010181">rlDisableVertexBuffer</span><span style="color:#000000">();</span>
    <span style="color:#010181">rlDisableVertexBufferElement</span><span style="color:#000000">();</span>
    <span style="color:#838183; font-style:italic">// Disable shader program</span>
    <span style="color:#010181">rlDisableShader</span><span style="color:#000000">();</span>
    <span style="color:#838183; font-style:italic">// Remove instance transforms buffer</span>
    <span style="color:#010181">rlUnloadVertexBuffer</span><span style="color:#000000">(</span>instancesVboId<span style="color:#000000">);</span>
    <span style="color:#010181">RL_FREE</span><span style="color:#000000">(</span>instanceTransforms<span style="color:#000000">);</span>
<span style="color:#008200">#endif</span>
<span style="color:#000000">}</span>
