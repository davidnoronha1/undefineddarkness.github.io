Vector2 <span style="color:#010181">GetWorldToScreenEx</span><span style="color:#000000">(</span>Vector3 position<span style="color:#000000">,</span> Camera camera<span style="color:#000000">,</span> <span style="color:#0057ae">int</span> width<span style="color:#000000">,</span> <span style="color:#0057ae">int</span> height<span style="color:#000000">){</span>
    <span style="color:#838183; font-style:italic">// Calculate projection matrix (from perspective instead of frustum</span>
    Matrix matProj <span style="color:#000000">=</span> <span style="color:#010181">MatrixIdentity</span><span style="color:#000000">();</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>camera<span style="color:#000000">.</span>projection <span style="color:#000000">==</span> CAMERA_PERSPECTIVE<span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#838183; font-style:italic">// Calculate projection matrix from perspective</span>
        matProj <span style="color:#000000">=</span> <span style="color:#010181">MatrixPerspective</span><span style="color:#000000">(</span>camera<span style="color:#000000">.</span>fovy<span style="color:#000000">*</span>DEG2RAD<span style="color:#000000">, ((</span><span style="color:#0057ae">double</span><span style="color:#000000">)</span>width<span style="color:#000000">/(</span><span style="color:#0057ae">double</span><span style="color:#000000">)</span>height<span style="color:#000000">),</span> RL_CULL_DISTANCE_NEAR<span style="color:#000000">,</span> RL_CULL_DISTANCE_FAR<span style="color:#000000">);</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">else if</span> <span style="color:#000000">(</span>camera<span style="color:#000000">.</span>projection <span style="color:#000000">==</span> CAMERA_ORTHOGRAPHIC<span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#0057ae">float</span> aspect <span style="color:#000000">= (</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>CORE<span style="color:#000000">.</span>Window<span style="color:#000000">.</span>screen<span style="color:#000000">.</span>width<span style="color:#000000">/(</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>CORE<span style="color:#000000">.</span>Window<span style="color:#000000">.</span>screen<span style="color:#000000">.</span>height<span style="color:#000000">;</span>
        <span style="color:#0057ae">double</span> top <span style="color:#000000">=</span> camera<span style="color:#000000">.</span>fovy<span style="color:#000000">/</span><span style="color:#b07e00">2.0</span><span style="color:#000000">;</span>
        <span style="color:#0057ae">double</span> right <span style="color:#000000">=</span> top<span style="color:#000000">*</span>aspect<span style="color:#000000">;</span>
        <span style="color:#838183; font-style:italic">// Calculate projection matrix from orthographic</span>
        matProj <span style="color:#000000">=</span> <span style="color:#010181">MatrixOrtho</span><span style="color:#000000">(-</span>right<span style="color:#000000">,</span> right<span style="color:#000000">, -</span>top<span style="color:#000000">,</span> top<span style="color:#000000">,</span> RL_CULL_DISTANCE_NEAR<span style="color:#000000">,</span> RL_CULL_DISTANCE_FAR<span style="color:#000000">);</span>
    <span style="color:#000000">}</span>
    <span style="color:#838183; font-style:italic">// Calculate view matrix from camera look at (and transpose it)</span>
    Matrix matView <span style="color:#000000">=</span> <span style="color:#010181">MatrixLookAt</span><span style="color:#000000">(</span>camera<span style="color:#000000">.</span>position<span style="color:#000000">,</span> camera<span style="color:#000000">.</span>target<span style="color:#000000">,</span> camera<span style="color:#000000">.</span>up<span style="color:#000000">);</span>
    <span style="color:#838183; font-style:italic">// TODO: Why not use Vector3Transform(Vector3 v, Matrix mat)?</span>
    <span style="color:#838183; font-style:italic">// Convert world position vector to quaternion</span>
    Quaternion worldPos <span style="color:#000000">= {</span> position<span style="color:#000000">.</span>x<span style="color:#000000">,</span> position<span style="color:#000000">.</span>y<span style="color:#000000">,</span> position<span style="color:#000000">.</span>z<span style="color:#000000">,</span> <span style="color:#b07e00">1.0</span>f <span style="color:#000000">};</span>
    <span style="color:#838183; font-style:italic">// Transform world position to view</span>
    worldPos <span style="color:#000000">=</span> <span style="color:#010181">QuaternionTransform</span><span style="color:#000000">(</span>worldPos<span style="color:#000000">,</span> matView<span style="color:#000000">);</span>
    <span style="color:#838183; font-style:italic">// Transform result to projection (clip space position)</span>
    worldPos <span style="color:#000000">=</span> <span style="color:#010181">QuaternionTransform</span><span style="color:#000000">(</span>worldPos<span style="color:#000000">,</span> matProj<span style="color:#000000">);</span>
    <span style="color:#838183; font-style:italic">// Calculate normalized device coordinates (inverted y)</span>
    Vector3 ndcPos <span style="color:#000000">= {</span> worldPos<span style="color:#000000">.</span>x<span style="color:#000000">/</span>worldPos<span style="color:#000000">.</span>w<span style="color:#000000">, -</span>worldPos<span style="color:#000000">.</span>y<span style="color:#000000">/</span>worldPos<span style="color:#000000">.</span>w<span style="color:#000000">,</span> worldPos<span style="color:#000000">.</span>z<span style="color:#000000">/</span>worldPos<span style="color:#000000">.</span>w <span style="color:#000000">};</span>
    <span style="color:#838183; font-style:italic">// Calculate 2d screen position vector</span>
    Vector2 screenPosition <span style="color:#000000">= { (</span>ndcPos<span style="color:#000000">.</span>x <span style="color:#000000">+</span> <span style="color:#b07e00">1.0</span>f<span style="color:#000000">)/</span><span style="color:#b07e00">2.0</span>f<span style="color:#000000">*(</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>width<span style="color:#000000">, (</span>ndcPos<span style="color:#000000">.</span>y <span style="color:#000000">+</span> <span style="color:#b07e00">1.0</span>f<span style="color:#000000">)/</span><span style="color:#b07e00">2.0</span>f<span style="color:#000000">*(</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>height <span style="color:#000000">};</span>
    <span style="color:#000000; font-weight:bold">return</span> screenPosition<span style="color:#000000">;</span>
<span style="color:#000000">}</span>
