<span style="color:#0057ae">void</span> <span style="color:#010181">ImageDither</span><span style="color:#000000">(</span>Image <span style="color:#000000">*</span>image<span style="color:#000000">,</span> <span style="color:#0057ae">int</span> rBpp<span style="color:#000000">,</span> <span style="color:#0057ae">int</span> gBpp<span style="color:#000000">,</span> <span style="color:#0057ae">int</span> bBpp<span style="color:#000000">,</span> <span style="color:#0057ae">int</span> aBpp<span style="color:#000000">){</span>
    <span style="color:#838183; font-style:italic">// Security check to avoid program crash</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>image<span style="color:#000000">-&gt;</span>data <span style="color:#000000">==</span> NULL<span style="color:#000000">) || (</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">==</span> <span style="color:#b07e00">0</span><span style="color:#000000">) || (</span>image<span style="color:#000000">-&gt;</span>height <span style="color:#000000">==</span> <span style="color:#b07e00">0</span><span style="color:#000000">))</span> <span style="color:#000000; font-weight:bold">return</span><span style="color:#000000">;</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>image<span style="color:#000000">-&gt;</span>format <span style="color:#000000">&gt;=</span> PIXELFORMAT_COMPRESSED_DXT1_RGB<span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_WARNING<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;IMAGE: Compressed data formats can not be dithered&quot;</span><span style="color:#000000">);</span>
        <span style="color:#000000; font-weight:bold">return</span><span style="color:#000000">;</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>rBpp <span style="color:#000000">+</span> gBpp <span style="color:#000000">+</span> bBpp <span style="color:#000000">+</span> aBpp<span style="color:#000000">) &gt;</span> <span style="color:#b07e00">16</span><span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_WARNING<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;IMAGE: Unsupported dithering bpps (%ibpp), only 16bpp or lower modes supported&quot;</span><span style="color:#000000">, (</span>rBpp<span style="color:#000000">+</span>gBpp<span style="color:#000000">+</span>bBpp<span style="color:#000000">+</span>aBpp<span style="color:#000000">));</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">else</span>
    <span style="color:#000000">{</span>
        Color <span style="color:#000000">*</span>pixels <span style="color:#000000">=</span> <span style="color:#010181">LoadImageColors</span><span style="color:#000000">(*</span>image<span style="color:#000000">);</span>
        <span style="color:#010181">RL_FREE</span><span style="color:#000000">(</span>image<span style="color:#000000">-&gt;</span>data<span style="color:#000000">);</span>      <span style="color:#838183; font-style:italic">// free old image data</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>image<span style="color:#000000">-&gt;</span>format <span style="color:#000000">!=</span> PIXELFORMAT_UNCOMPRESSED_R8G8B8<span style="color:#000000">) &amp;&amp; (</span>image<span style="color:#000000">-&gt;</span>format <span style="color:#000000">!=</span> PIXELFORMAT_UNCOMPRESSED_R8G8B8A8<span style="color:#000000">))</span>
        <span style="color:#000000">{</span>
            <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_WARNING<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;IMAGE: Format is already 16bpp or lower, dithering could have no effect&quot;</span><span style="color:#000000">);</span>
        <span style="color:#000000">}</span>
        <span style="color:#838183; font-style:italic">// Define new image format, check if desired bpp match internal known format</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>rBpp <span style="color:#000000">==</span> <span style="color:#b07e00">5</span><span style="color:#000000">) &amp;&amp; (</span>gBpp <span style="color:#000000">==</span> <span style="color:#b07e00">6</span><span style="color:#000000">) &amp;&amp; (</span>bBpp <span style="color:#000000">==</span> <span style="color:#b07e00">5</span><span style="color:#000000">) &amp;&amp; (</span>aBpp <span style="color:#000000">==</span> <span style="color:#b07e00">0</span><span style="color:#000000">))</span> image<span style="color:#000000">-&gt;</span>format <span style="color:#000000">=</span> PIXELFORMAT_UNCOMPRESSED_R5G6B5<span style="color:#000000">;</span>
        <span style="color:#000000; font-weight:bold">else if</span> <span style="color:#000000">((</span>rBpp <span style="color:#000000">==</span> <span style="color:#b07e00">5</span><span style="color:#000000">) &amp;&amp; (</span>gBpp <span style="color:#000000">==</span> <span style="color:#b07e00">5</span><span style="color:#000000">) &amp;&amp; (</span>bBpp <span style="color:#000000">==</span> <span style="color:#b07e00">5</span><span style="color:#000000">) &amp;&amp; (</span>aBpp <span style="color:#000000">==</span> <span style="color:#b07e00">1</span><span style="color:#000000">))</span> image<span style="color:#000000">-&gt;</span>format <span style="color:#000000">=</span> PIXELFORMAT_UNCOMPRESSED_R5G5B5A1<span style="color:#000000">;</span>
        <span style="color:#000000; font-weight:bold">else if</span> <span style="color:#000000">((</span>rBpp <span style="color:#000000">==</span> <span style="color:#b07e00">4</span><span style="color:#000000">) &amp;&amp; (</span>gBpp <span style="color:#000000">==</span> <span style="color:#b07e00">4</span><span style="color:#000000">) &amp;&amp; (</span>bBpp <span style="color:#000000">==</span> <span style="color:#b07e00">4</span><span style="color:#000000">) &amp;&amp; (</span>aBpp <span style="color:#000000">==</span> <span style="color:#b07e00">4</span><span style="color:#000000">))</span> image<span style="color:#000000">-&gt;</span>format <span style="color:#000000">=</span> PIXELFORMAT_UNCOMPRESSED_R4G4B4A4<span style="color:#000000">;</span>
        <span style="color:#000000; font-weight:bold">else</span>
        <span style="color:#000000">{</span>
            image<span style="color:#000000">-&gt;</span>format <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span>
            <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_WARNING<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;IMAGE: Unsupported dithered OpenGL internal format: %ibpp (R%iG%iB%iA%i)&quot;</span><span style="color:#000000">, (</span>rBpp<span style="color:#000000">+</span>gBpp<span style="color:#000000">+</span>bBpp<span style="color:#000000">+</span>aBpp<span style="color:#000000">),</span> rBpp<span style="color:#000000">,</span> gBpp<span style="color:#000000">,</span> bBpp<span style="color:#000000">,</span> aBpp<span style="color:#000000">);</span>
        <span style="color:#000000">}</span>
        <span style="color:#838183; font-style:italic">// NOTE: We will store the dithered data as unsigned short (16bpp)</span>
        image<span style="color:#000000">-&gt;</span>data <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned short</span> <span style="color:#000000">*)</span><span style="color:#010181">RL_MALLOC</span><span style="color:#000000">(</span>image<span style="color:#000000">-&gt;</span>width<span style="color:#000000">*</span>image<span style="color:#000000">-&gt;</span>height<span style="color:#000000">*</span><span style="color:#000000; font-weight:bold">sizeof</span><span style="color:#000000">(</span><span style="color:#0057ae">unsigned short</span><span style="color:#000000">));</span>
        Color oldPixel <span style="color:#000000">=</span> WHITE<span style="color:#000000">;</span>
        Color newPixel <span style="color:#000000">=</span> WHITE<span style="color:#000000">;</span>
        <span style="color:#0057ae">int</span> rError<span style="color:#000000">,</span> gError<span style="color:#000000">,</span> bError<span style="color:#000000">;</span>
        <span style="color:#0057ae">unsigned short</span> rPixel<span style="color:#000000">,</span> gPixel<span style="color:#000000">,</span> bPixel<span style="color:#000000">,</span> aPixel<span style="color:#000000">;</span>   <span style="color:#838183; font-style:italic">// Used for 16bit pixel composition</span>
        <span style="color:#008200">#define MIN(a,b) (((a)&lt;(b))?(a):(b))</span>
        <span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span><span style="color:#0057ae">int</span> y <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span> y <span style="color:#000000">&lt;</span> image<span style="color:#000000">-&gt;</span>height<span style="color:#000000">;</span> y<span style="color:#000000">++)</span>
        <span style="color:#000000">{</span>
            <span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span><span style="color:#0057ae">int</span> x <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span> x <span style="color:#000000">&lt;</span> image<span style="color:#000000">-&gt;</span>width<span style="color:#000000">;</span> x<span style="color:#000000">++)</span>
            <span style="color:#000000">{</span>
                oldPixel <span style="color:#000000">=</span> pixels<span style="color:#000000">[</span>y<span style="color:#000000">*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">];</span>
                <span style="color:#838183; font-style:italic">// NOTE: New pixel obtained by bits truncate, it would be better to round values (check ImageFormat())</span>
                newPixel<span style="color:#000000">.</span>r <span style="color:#000000">=</span> oldPixel<span style="color:#000000">.</span>r <span style="color:#000000">&gt;&gt; (</span><span style="color:#b07e00">8</span> <span style="color:#000000">-</span> rBpp<span style="color:#000000">);</span>     <span style="color:#838183; font-style:italic">// R bits</span>
                newPixel<span style="color:#000000">.</span>g <span style="color:#000000">=</span> oldPixel<span style="color:#000000">.</span>g <span style="color:#000000">&gt;&gt; (</span><span style="color:#b07e00">8</span> <span style="color:#000000">-</span> gBpp<span style="color:#000000">);</span>     <span style="color:#838183; font-style:italic">// G bits</span>
                newPixel<span style="color:#000000">.</span>b <span style="color:#000000">=</span> oldPixel<span style="color:#000000">.</span>b <span style="color:#000000">&gt;&gt; (</span><span style="color:#b07e00">8</span> <span style="color:#000000">-</span> bBpp<span style="color:#000000">);</span>     <span style="color:#838183; font-style:italic">// B bits</span>
                newPixel<span style="color:#000000">.</span>a <span style="color:#000000">=</span> oldPixel<span style="color:#000000">.</span>a <span style="color:#000000">&gt;&gt; (</span><span style="color:#b07e00">8</span> <span style="color:#000000">-</span> aBpp<span style="color:#000000">);</span>     <span style="color:#838183; font-style:italic">// A bits (not used on dithering)</span>
                <span style="color:#838183; font-style:italic">// NOTE: Error must be computed between new and old pixel but using same number of bits!</span>
                <span style="color:#838183; font-style:italic">// We want to know how much color precision we have lost...</span>
                rError <span style="color:#000000">= (</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>oldPixel<span style="color:#000000">.</span>r <span style="color:#000000">- (</span><span style="color:#0057ae">int</span><span style="color:#000000">)(</span>newPixel<span style="color:#000000">.</span>r <span style="color:#000000">&lt;&lt; (</span><span style="color:#b07e00">8</span> <span style="color:#000000">-</span> rBpp<span style="color:#000000">));</span>
                gError <span style="color:#000000">= (</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>oldPixel<span style="color:#000000">.</span>g <span style="color:#000000">- (</span><span style="color:#0057ae">int</span><span style="color:#000000">)(</span>newPixel<span style="color:#000000">.</span>g <span style="color:#000000">&lt;&lt; (</span><span style="color:#b07e00">8</span> <span style="color:#000000">-</span> gBpp<span style="color:#000000">));</span>
                bError <span style="color:#000000">= (</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>oldPixel<span style="color:#000000">.</span>b <span style="color:#000000">- (</span><span style="color:#0057ae">int</span><span style="color:#000000">)(</span>newPixel<span style="color:#000000">.</span>b <span style="color:#000000">&lt;&lt; (</span><span style="color:#b07e00">8</span> <span style="color:#000000">-</span> bBpp<span style="color:#000000">));</span>
                pixels<span style="color:#000000">[</span>y<span style="color:#000000">*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">] =</span> newPixel<span style="color:#000000">;</span>
                <span style="color:#838183; font-style:italic">// NOTE: Some cases are out of the array and should be ignored</span>
                <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>x <span style="color:#000000">&lt; (</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">-</span> <span style="color:#b07e00">1</span><span style="color:#000000">))</span>
                <span style="color:#000000">{</span>
                    pixels<span style="color:#000000">[</span>y<span style="color:#000000">*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>r <span style="color:#000000">=</span> <span style="color:#010181">MIN</span><span style="color:#000000">((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>pixels<span style="color:#000000">[</span>y<span style="color:#000000">*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>r <span style="color:#000000">+ (</span><span style="color:#0057ae">int</span><span style="color:#000000">)((</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>rError<span style="color:#000000">*</span><span style="color:#b07e00">7.0</span>f<span style="color:#000000">/</span><span style="color:#b07e00">16</span><span style="color:#000000">),</span> <span style="color:#b07e00">0xff</span><span style="color:#000000">);</span>
                    pixels<span style="color:#000000">[</span>y<span style="color:#000000">*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>g <span style="color:#000000">=</span> <span style="color:#010181">MIN</span><span style="color:#000000">((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>pixels<span style="color:#000000">[</span>y<span style="color:#000000">*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>g <span style="color:#000000">+ (</span><span style="color:#0057ae">int</span><span style="color:#000000">)((</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>gError<span style="color:#000000">*</span><span style="color:#b07e00">7.0</span>f<span style="color:#000000">/</span><span style="color:#b07e00">16</span><span style="color:#000000">),</span> <span style="color:#b07e00">0xff</span><span style="color:#000000">);</span>
                    pixels<span style="color:#000000">[</span>y<span style="color:#000000">*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>b <span style="color:#000000">=</span> <span style="color:#010181">MIN</span><span style="color:#000000">((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>pixels<span style="color:#000000">[</span>y<span style="color:#000000">*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>b <span style="color:#000000">+ (</span><span style="color:#0057ae">int</span><span style="color:#000000">)((</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>bError<span style="color:#000000">*</span><span style="color:#b07e00">7.0</span>f<span style="color:#000000">/</span><span style="color:#b07e00">16</span><span style="color:#000000">),</span> <span style="color:#b07e00">0xff</span><span style="color:#000000">);</span>
                <span style="color:#000000">}</span>
                <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>x <span style="color:#000000">&gt;</span> <span style="color:#b07e00">0</span><span style="color:#000000">) &amp;&amp; (</span>y <span style="color:#000000">&lt; (</span>image<span style="color:#000000">-&gt;</span>height <span style="color:#000000">-</span> <span style="color:#b07e00">1</span><span style="color:#000000">)))</span>
                <span style="color:#000000">{</span>
                    pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">-</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>r <span style="color:#000000">=</span> <span style="color:#010181">MIN</span><span style="color:#000000">((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">-</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>r <span style="color:#000000">+ (</span><span style="color:#0057ae">int</span><span style="color:#000000">)((</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>rError<span style="color:#000000">*</span><span style="color:#b07e00">3.0</span>f<span style="color:#000000">/</span><span style="color:#b07e00">16</span><span style="color:#000000">),</span> <span style="color:#b07e00">0xff</span><span style="color:#000000">);</span>
                    pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">-</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>g <span style="color:#000000">=</span> <span style="color:#010181">MIN</span><span style="color:#000000">((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">-</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>g <span style="color:#000000">+ (</span><span style="color:#0057ae">int</span><span style="color:#000000">)((</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>gError<span style="color:#000000">*</span><span style="color:#b07e00">3.0</span>f<span style="color:#000000">/</span><span style="color:#b07e00">16</span><span style="color:#000000">),</span> <span style="color:#b07e00">0xff</span><span style="color:#000000">);</span>
                    pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">-</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>b <span style="color:#000000">=</span> <span style="color:#010181">MIN</span><span style="color:#000000">((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">-</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>b <span style="color:#000000">+ (</span><span style="color:#0057ae">int</span><span style="color:#000000">)((</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>bError<span style="color:#000000">*</span><span style="color:#b07e00">3.0</span>f<span style="color:#000000">/</span><span style="color:#b07e00">16</span><span style="color:#000000">),</span> <span style="color:#b07e00">0xff</span><span style="color:#000000">);</span>
                <span style="color:#000000">}</span>
                <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>y <span style="color:#000000">&lt; (</span>image<span style="color:#000000">-&gt;</span>height <span style="color:#000000">-</span> <span style="color:#b07e00">1</span><span style="color:#000000">))</span>
                <span style="color:#000000">{</span>
                    pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">].</span>r <span style="color:#000000">=</span> <span style="color:#010181">MIN</span><span style="color:#000000">((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">].</span>r <span style="color:#000000">+ (</span><span style="color:#0057ae">int</span><span style="color:#000000">)((</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>rError<span style="color:#000000">*</span><span style="color:#b07e00">5.0</span>f<span style="color:#000000">/</span><span style="color:#b07e00">16</span><span style="color:#000000">),</span> <span style="color:#b07e00">0xff</span><span style="color:#000000">);</span>
                    pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">].</span>g <span style="color:#000000">=</span> <span style="color:#010181">MIN</span><span style="color:#000000">((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">].</span>g <span style="color:#000000">+ (</span><span style="color:#0057ae">int</span><span style="color:#000000">)((</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>gError<span style="color:#000000">*</span><span style="color:#b07e00">5.0</span>f<span style="color:#000000">/</span><span style="color:#b07e00">16</span><span style="color:#000000">),</span> <span style="color:#b07e00">0xff</span><span style="color:#000000">);</span>
                    pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">].</span>b <span style="color:#000000">=</span> <span style="color:#010181">MIN</span><span style="color:#000000">((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">].</span>b <span style="color:#000000">+ (</span><span style="color:#0057ae">int</span><span style="color:#000000">)((</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>bError<span style="color:#000000">*</span><span style="color:#b07e00">5.0</span>f<span style="color:#000000">/</span><span style="color:#b07e00">16</span><span style="color:#000000">),</span> <span style="color:#b07e00">0xff</span><span style="color:#000000">);</span>
                <span style="color:#000000">}</span>
                <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>x <span style="color:#000000">&lt; (</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">-</span> <span style="color:#b07e00">1</span><span style="color:#000000">)) &amp;&amp; (</span>y <span style="color:#000000">&lt; (</span>image<span style="color:#000000">-&gt;</span>height <span style="color:#000000">-</span> <span style="color:#b07e00">1</span><span style="color:#000000">)))</span>
                <span style="color:#000000">{</span>
                    pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>r <span style="color:#000000">=</span> <span style="color:#010181">MIN</span><span style="color:#000000">((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>r <span style="color:#000000">+ (</span><span style="color:#0057ae">int</span><span style="color:#000000">)((</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>rError<span style="color:#000000">*</span><span style="color:#b07e00">1.0</span>f<span style="color:#000000">/</span><span style="color:#b07e00">16</span><span style="color:#000000">),</span> <span style="color:#b07e00">0xff</span><span style="color:#000000">);</span>
                    pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>g <span style="color:#000000">=</span> <span style="color:#010181">MIN</span><span style="color:#000000">((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>g <span style="color:#000000">+ (</span><span style="color:#0057ae">int</span><span style="color:#000000">)((</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>gError<span style="color:#000000">*</span><span style="color:#b07e00">1.0</span>f<span style="color:#000000">/</span><span style="color:#b07e00">16</span><span style="color:#000000">),</span> <span style="color:#b07e00">0xff</span><span style="color:#000000">);</span>
                    pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>b <span style="color:#000000">=</span> <span style="color:#010181">MIN</span><span style="color:#000000">((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>pixels<span style="color:#000000">[(</span>y<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">)*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">].</span>b <span style="color:#000000">+ (</span><span style="color:#0057ae">int</span><span style="color:#000000">)((</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>bError<span style="color:#000000">*</span><span style="color:#b07e00">1.0</span>f<span style="color:#000000">/</span><span style="color:#b07e00">16</span><span style="color:#000000">),</span> <span style="color:#b07e00">0xff</span><span style="color:#000000">);</span>
                <span style="color:#000000">}</span>
                rPixel <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned short</span><span style="color:#000000">)</span>newPixel<span style="color:#000000">.</span>r<span style="color:#000000">;</span>
                gPixel <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned short</span><span style="color:#000000">)</span>newPixel<span style="color:#000000">.</span>g<span style="color:#000000">;</span>
                bPixel <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned short</span><span style="color:#000000">)</span>newPixel<span style="color:#000000">.</span>b<span style="color:#000000">;</span>
                aPixel <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned short</span><span style="color:#000000">)</span>newPixel<span style="color:#000000">.</span>a<span style="color:#000000">;</span>
                <span style="color:#000000">((</span><span style="color:#0057ae">unsigned short</span> <span style="color:#000000">*)</span>image<span style="color:#000000">-&gt;</span>data<span style="color:#000000">)[</span>y<span style="color:#000000">*</span>image<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+</span> x<span style="color:#000000">] = (</span>rPixel <span style="color:#000000">&lt;&lt; (</span>gBpp <span style="color:#000000">+</span> bBpp <span style="color:#000000">+</span> aBpp<span style="color:#000000">)) | (</span>gPixel <span style="color:#000000">&lt;&lt; (</span>bBpp <span style="color:#000000">+</span> aBpp<span style="color:#000000">)) | (</span>bPixel <span style="color:#000000">&lt;&lt;</span> aBpp<span style="color:#000000">) |</span> aPixel<span style="color:#000000">;</span>
            <span style="color:#000000">}</span>
        <span style="color:#000000">}</span>
        <span style="color:#010181">UnloadImageColors</span><span style="color:#000000">(</span>pixels<span style="color:#000000">);</span>
    <span style="color:#000000">}</span>
<span style="color:#000000">}</span>
