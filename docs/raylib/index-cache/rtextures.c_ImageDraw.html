<span style="color:#0057ae">void</span> <span style="color:#010181">ImageDraw</span><span style="color:#000000">(</span>Image <span style="color:#000000">*</span>dst<span style="color:#000000">,</span> Image src<span style="color:#000000">,</span> Rectangle srcRec<span style="color:#000000">,</span> Rectangle dstRec<span style="color:#000000">,</span> Color tint<span style="color:#000000">){</span>
    <span style="color:#838183; font-style:italic">// Security check to avoid program crash</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>dst<span style="color:#000000">-&gt;</span>data <span style="color:#000000">==</span> NULL<span style="color:#000000">) || (</span>dst<span style="color:#000000">-&gt;</span>width <span style="color:#000000">==</span> <span style="color:#b07e00">0</span><span style="color:#000000">) || (</span>dst<span style="color:#000000">-&gt;</span>height <span style="color:#000000">==</span> <span style="color:#b07e00">0</span><span style="color:#000000">) ||</span>
        <span style="color:#000000">(</span>src<span style="color:#000000">.</span>data <span style="color:#000000">==</span> NULL<span style="color:#000000">) || (</span>src<span style="color:#000000">.</span>width <span style="color:#000000">==</span> <span style="color:#b07e00">0</span><span style="color:#000000">) || (</span>src<span style="color:#000000">.</span>height <span style="color:#000000">==</span> <span style="color:#b07e00">0</span><span style="color:#000000">))</span> <span style="color:#000000; font-weight:bold">return</span><span style="color:#000000">;</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>dst<span style="color:#000000">-&gt;</span>mipmaps <span style="color:#000000">&gt;</span> <span style="color:#b07e00">1</span><span style="color:#000000">)</span> <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_WARNING<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;Image drawing only applied to base mipmap level&quot;</span><span style="color:#000000">);</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>dst<span style="color:#000000">-&gt;</span>format <span style="color:#000000">&gt;=</span> PIXELFORMAT_COMPRESSED_DXT1_RGB<span style="color:#000000">)</span> <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_WARNING<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;Image drawing not supported for compressed formats&quot;</span><span style="color:#000000">);</span>
    <span style="color:#000000; font-weight:bold">else</span>
    <span style="color:#000000">{</span>
        Image srcMod <span style="color:#000000">= {</span> <span style="color:#b07e00">0</span> <span style="color:#000000">};</span>       <span style="color:#838183; font-style:italic">// Source copy (in case it was required)</span>
        Image <span style="color:#000000">*</span>srcPtr <span style="color:#000000">= &amp;</span>src<span style="color:#000000">;</span>       <span style="color:#838183; font-style:italic">// Pointer to source image</span>
        <span style="color:#0057ae">bool</span> useSrcMod <span style="color:#000000">=</span> <span style="color:#000000; font-weight:bold">false</span><span style="color:#000000">;</span>     <span style="color:#838183; font-style:italic">// Track source copy required</span>
        <span style="color:#838183; font-style:italic">// Source rectangle out-of-bounds security checks</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>srcRec<span style="color:#000000">.</span>x <span style="color:#000000">&lt;</span> <span style="color:#b07e00">0</span><span style="color:#000000">) {</span> srcRec<span style="color:#000000">.</span>width <span style="color:#000000">+=</span> srcRec<span style="color:#000000">.</span>x<span style="color:#000000">;</span> srcRec<span style="color:#000000">.</span>x <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">; }</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>srcRec<span style="color:#000000">.</span>y <span style="color:#000000">&lt;</span> <span style="color:#b07e00">0</span><span style="color:#000000">) {</span> srcRec<span style="color:#000000">.</span>height <span style="color:#000000">+=</span> srcRec<span style="color:#000000">.</span>y<span style="color:#000000">;</span> srcRec<span style="color:#000000">.</span>y <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">; }</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>srcRec<span style="color:#000000">.</span>x <span style="color:#000000">+</span> srcRec<span style="color:#000000">.</span>width<span style="color:#000000">) &gt;</span> src<span style="color:#000000">.</span>width<span style="color:#000000">)</span> srcRec<span style="color:#000000">.</span>width <span style="color:#000000">=</span> src<span style="color:#000000">.</span>width <span style="color:#000000">-</span> srcRec<span style="color:#000000">.</span>x<span style="color:#000000">;</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>srcRec<span style="color:#000000">.</span>y <span style="color:#000000">+</span> srcRec<span style="color:#000000">.</span>height<span style="color:#000000">) &gt;</span> src<span style="color:#000000">.</span>height<span style="color:#000000">)</span> srcRec<span style="color:#000000">.</span>height <span style="color:#000000">=</span> src<span style="color:#000000">.</span>height <span style="color:#000000">-</span> srcRec<span style="color:#000000">.</span>y<span style="color:#000000">;</span>
        <span style="color:#838183; font-style:italic">// Check if source rectangle needs to be resized to destination rectangle</span>
        <span style="color:#838183; font-style:italic">// In that case, we make a copy of source, and we apply all required transform</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>srcRec<span style="color:#000000">.</span>width <span style="color:#000000">!= (</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>dstRec<span style="color:#000000">.</span>width<span style="color:#000000">) || ((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>srcRec<span style="color:#000000">.</span>height <span style="color:#000000">!= (</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>dstRec<span style="color:#000000">.</span>height<span style="color:#000000">))</span>
        <span style="color:#000000">{</span>
            srcMod <span style="color:#000000">=</span> <span style="color:#010181">ImageFromImage</span><span style="color:#000000">(</span>src<span style="color:#000000">,</span> srcRec<span style="color:#000000">);</span>   <span style="color:#838183; font-style:italic">// Create image from another image</span>
            <span style="color:#010181">ImageResize</span><span style="color:#000000">(&amp;</span>srcMod<span style="color:#000000">, (</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>dstRec<span style="color:#000000">.</span>width<span style="color:#000000">, (</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>dstRec<span style="color:#000000">.</span>height<span style="color:#000000">);</span>   <span style="color:#838183; font-style:italic">// Resize to destination rectangle</span>
            srcRec <span style="color:#000000">= (</span>Rectangle<span style="color:#000000">){</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">, (</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>srcMod<span style="color:#000000">.</span>width<span style="color:#000000">, (</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>srcMod<span style="color:#000000">.</span>height <span style="color:#000000">};</span>
            srcPtr <span style="color:#000000">= &amp;</span>srcMod<span style="color:#000000">;</span>
            useSrcMod <span style="color:#000000">=</span> <span style="color:#000000; font-weight:bold">true</span><span style="color:#000000">;</span>
        <span style="color:#000000">}</span>
        <span style="color:#838183; font-style:italic">// Destination rectangle out-of-bounds security checks</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>dstRec<span style="color:#000000">.</span>x <span style="color:#000000">&lt;</span> <span style="color:#b07e00">0</span><span style="color:#000000">)</span>
        <span style="color:#000000">{</span>
            srcRec<span style="color:#000000">.</span>x <span style="color:#000000">= -</span>dstRec<span style="color:#000000">.</span>x<span style="color:#000000">;</span>
            srcRec<span style="color:#000000">.</span>width <span style="color:#000000">+=</span> dstRec<span style="color:#000000">.</span>x<span style="color:#000000">;</span>
            dstRec<span style="color:#000000">.</span>x <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span>
        <span style="color:#000000">}</span>
        <span style="color:#000000; font-weight:bold">else if</span> <span style="color:#000000">((</span>dstRec<span style="color:#000000">.</span>x <span style="color:#000000">+</span> srcRec<span style="color:#000000">.</span>width<span style="color:#000000">) &gt;</span> dst<span style="color:#000000">-&gt;</span>width<span style="color:#000000">)</span> srcRec<span style="color:#000000">.</span>width <span style="color:#000000">=</span> dst<span style="color:#000000">-&gt;</span>width <span style="color:#000000">-</span> dstRec<span style="color:#000000">.</span>x<span style="color:#000000">;</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>dstRec<span style="color:#000000">.</span>y <span style="color:#000000">&lt;</span> <span style="color:#b07e00">0</span><span style="color:#000000">)</span>
        <span style="color:#000000">{</span>
            srcRec<span style="color:#000000">.</span>y <span style="color:#000000">= -</span>dstRec<span style="color:#000000">.</span>y<span style="color:#000000">;</span>
            srcRec<span style="color:#000000">.</span>height <span style="color:#000000">+=</span> dstRec<span style="color:#000000">.</span>y<span style="color:#000000">;</span>
            dstRec<span style="color:#000000">.</span>y <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span>
        <span style="color:#000000">}</span>
        <span style="color:#000000; font-weight:bold">else if</span> <span style="color:#000000">((</span>dstRec<span style="color:#000000">.</span>y <span style="color:#000000">+</span> srcRec<span style="color:#000000">.</span>height<span style="color:#000000">) &gt;</span> dst<span style="color:#000000">-&gt;</span>height<span style="color:#000000">)</span> srcRec<span style="color:#000000">.</span>height <span style="color:#000000">=</span> dst<span style="color:#000000">-&gt;</span>height <span style="color:#000000">-</span> dstRec<span style="color:#000000">.</span>y<span style="color:#000000">;</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>dst<span style="color:#000000">-&gt;</span>width <span style="color:#000000">&lt;</span> srcRec<span style="color:#000000">.</span>width<span style="color:#000000">)</span> srcRec<span style="color:#000000">.</span>width <span style="color:#000000">= (</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>dst<span style="color:#000000">-&gt;</span>width<span style="color:#000000">;</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>dst<span style="color:#000000">-&gt;</span>height <span style="color:#000000">&lt;</span> srcRec<span style="color:#000000">.</span>height<span style="color:#000000">)</span> srcRec<span style="color:#000000">.</span>height <span style="color:#000000">= (</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>dst<span style="color:#000000">-&gt;</span>height<span style="color:#000000">;</span>
        <span style="color:#838183; font-style:italic">// This blitting method is quite fast! The process followed is:</span>
        <span style="color:#838183; font-style:italic">// for every pixel -&gt; [get_src_format/get_dst_format -&gt; blend -&gt; format_to_dst]</span>
        <span style="color:#838183; font-style:italic">// Some optimization ideas:</span>
        <span style="color:#838183; font-style:italic">//    [x] Avoid creating source copy if not required (no resize required)</span>
        <span style="color:#838183; font-style:italic">//    [x] Optimize ImageResize() for pixel format (alternative: ImageResizeNN())</span>
        <span style="color:#838183; font-style:italic">//    [x] Optimize ColorAlphaBlend() to avoid processing (alpha = 0) and (alpha = 1)</span>
        <span style="color:#838183; font-style:italic">//    [x] Optimize ColorAlphaBlend() for faster operations (maybe avoiding divs?)</span>
        <span style="color:#838183; font-style:italic">//    [x] Consider fast path: no alpha blending required cases (src has no alpha)</span>
        <span style="color:#838183; font-style:italic">//    [x] Consider fast path: same src/dst format with no alpha -&gt; direct line copy</span>
        <span style="color:#838183; font-style:italic">//    [-] GetPixelColor(): Get Vector4 instead of Color, easier for ColorAlphaBlend()</span>
        <span style="color:#838183; font-style:italic">//    [ ] Support f32bit channels drawing</span>
        <span style="color:#838183; font-style:italic">// TODO: Support PIXELFORMAT_UNCOMPRESSED_R32, PIXELFORMAT_UNCOMPRESSED_R32G32B32, PIXELFORMAT_UNCOMPRESSED_R32G32B32A32</span>
        Color colSrc<span style="color:#000000">,</span> colDst<span style="color:#000000">,</span> blend<span style="color:#000000">;</span>
        <span style="color:#0057ae">bool</span> blendRequired <span style="color:#000000">=</span> <span style="color:#000000; font-weight:bold">true</span><span style="color:#000000">;</span>
        <span style="color:#838183; font-style:italic">// Fast path: Avoid blend if source has no alpha to blend</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">((</span>tint<span style="color:#000000">.</span>a <span style="color:#000000">==</span> <span style="color:#b07e00">255</span><span style="color:#000000">) &amp;&amp; ((</span>srcPtr<span style="color:#000000">-&gt;</span>format <span style="color:#000000">==</span> PIXELFORMAT_UNCOMPRESSED_GRAYSCALE<span style="color:#000000">) || (</span>srcPtr<span style="color:#000000">-&gt;</span>format <span style="color:#000000">==</span> PIXELFORMAT_UNCOMPRESSED_R8G8B8<span style="color:#000000">) || (</span>srcPtr<span style="color:#000000">-&gt;</span>format <span style="color:#000000">==</span> PIXELFORMAT_UNCOMPRESSED_R5G6B5<span style="color:#000000">)))</span> blendRequired <span style="color:#000000">=</span> <span style="color:#000000; font-weight:bold">false</span><span style="color:#000000">;</span>
        <span style="color:#0057ae">int</span> strideDst <span style="color:#000000">=</span> <span style="color:#010181">GetPixelDataSize</span><span style="color:#000000">(</span>dst<span style="color:#000000">-&gt;</span>width<span style="color:#000000">,</span> <span style="color:#b07e00">1</span><span style="color:#000000">,</span> dst<span style="color:#000000">-&gt;</span>format<span style="color:#000000">);</span>
        <span style="color:#0057ae">int</span> bytesPerPixelDst <span style="color:#000000">=</span> strideDst<span style="color:#000000">/(</span>dst<span style="color:#000000">-&gt;</span>width<span style="color:#000000">);</span>
        <span style="color:#0057ae">int</span> strideSrc <span style="color:#000000">=</span> <span style="color:#010181">GetPixelDataSize</span><span style="color:#000000">(</span>srcPtr<span style="color:#000000">-&gt;</span>width<span style="color:#000000">,</span> <span style="color:#b07e00">1</span><span style="color:#000000">,</span> srcPtr<span style="color:#000000">-&gt;</span>format<span style="color:#000000">);</span>
        <span style="color:#0057ae">int</span> bytesPerPixelSrc <span style="color:#000000">=</span> strideSrc<span style="color:#000000">/(</span>srcPtr<span style="color:#000000">-&gt;</span>width<span style="color:#000000">);</span>
        <span style="color:#0057ae">unsigned char</span> <span style="color:#000000">*</span>pSrcBase <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned char</span> <span style="color:#000000">*)</span>srcPtr<span style="color:#000000">-&gt;</span>data <span style="color:#000000">+ ((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>srcRec<span style="color:#000000">.</span>y<span style="color:#000000">*</span>srcPtr<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+ (</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>srcRec<span style="color:#000000">.</span>x<span style="color:#000000">)*</span>bytesPerPixelSrc<span style="color:#000000">;</span>
        <span style="color:#0057ae">unsigned char</span> <span style="color:#000000">*</span>pDstBase <span style="color:#000000">= (</span><span style="color:#0057ae">unsigned char</span> <span style="color:#000000">*)</span>dst<span style="color:#000000">-&gt;</span>data <span style="color:#000000">+ ((</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>dstRec<span style="color:#000000">.</span>y<span style="color:#000000">*</span>dst<span style="color:#000000">-&gt;</span>width <span style="color:#000000">+ (</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>dstRec<span style="color:#000000">.</span>x<span style="color:#000000">)*</span>bytesPerPixelDst<span style="color:#000000">;</span>
        <span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span><span style="color:#0057ae">int</span> y <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span> y <span style="color:#000000">&lt; (</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>srcRec<span style="color:#000000">.</span>height<span style="color:#000000">;</span> y<span style="color:#000000">++)</span>
        <span style="color:#000000">{</span>
            <span style="color:#0057ae">unsigned char</span> <span style="color:#000000">*</span>pSrc <span style="color:#000000">=</span> pSrcBase<span style="color:#000000">;</span>
            <span style="color:#0057ae">unsigned char</span> <span style="color:#000000">*</span>pDst <span style="color:#000000">=</span> pDstBase<span style="color:#000000">;</span>
            <span style="color:#838183; font-style:italic">// Fast path: Avoid moving pixel by pixel if no blend required and same format</span>
            <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(!</span>blendRequired <span style="color:#000000">&amp;&amp; (</span>srcPtr<span style="color:#000000">-&gt;</span>format <span style="color:#000000">==</span> dst<span style="color:#000000">-&gt;</span>format<span style="color:#000000">))</span> <span style="color:#010181">memcpy</span><span style="color:#000000">(</span>pDst<span style="color:#000000">,</span> pSrc<span style="color:#000000">, (</span><span style="color:#0057ae">int</span><span style="color:#000000">)(</span>srcRec<span style="color:#000000">.</span>width<span style="color:#000000">)*</span>bytesPerPixelSrc<span style="color:#000000">);</span>
            <span style="color:#000000; font-weight:bold">else</span>
            <span style="color:#000000">{</span>
                <span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span><span style="color:#0057ae">int</span> x <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span> x <span style="color:#000000">&lt; (</span><span style="color:#0057ae">int</span><span style="color:#000000">)</span>srcRec<span style="color:#000000">.</span>width<span style="color:#000000">;</span> x<span style="color:#000000">++)</span>
                <span style="color:#000000">{</span>
                    colSrc <span style="color:#000000">=</span> <span style="color:#010181">GetPixelColor</span><span style="color:#000000">(</span>pSrc<span style="color:#000000">,</span> srcPtr<span style="color:#000000">-&gt;</span>format<span style="color:#000000">);</span>
                    colDst <span style="color:#000000">=</span> <span style="color:#010181">GetPixelColor</span><span style="color:#000000">(</span>pDst<span style="color:#000000">,</span> dst<span style="color:#000000">-&gt;</span>format<span style="color:#000000">);</span>
                    <span style="color:#838183; font-style:italic">// Fast path: Avoid blend if source has no alpha to blend</span>
                    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>blendRequired<span style="color:#000000">)</span> blend <span style="color:#000000">=</span> <span style="color:#010181">ColorAlphaBlend</span><span style="color:#000000">(</span>colDst<span style="color:#000000">,</span> colSrc<span style="color:#000000">,</span> tint<span style="color:#000000">);</span>
                    <span style="color:#000000; font-weight:bold">else</span> blend <span style="color:#000000">=</span> colSrc<span style="color:#000000">;</span>
                    <span style="color:#010181">SetPixelColor</span><span style="color:#000000">(</span>pDst<span style="color:#000000">,</span> blend<span style="color:#000000">,</span> dst<span style="color:#000000">-&gt;</span>format<span style="color:#000000">);</span>
                    pDst <span style="color:#000000">+=</span> bytesPerPixelDst<span style="color:#000000">;</span>
                    pSrc <span style="color:#000000">+=</span> bytesPerPixelSrc<span style="color:#000000">;</span>
                <span style="color:#000000">}</span>
            <span style="color:#000000">}</span>
            pSrcBase <span style="color:#000000">+=</span> strideSrc<span style="color:#000000">;</span>
            pDstBase <span style="color:#000000">+=</span> strideDst<span style="color:#000000">;</span>
        <span style="color:#000000">}</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>useSrcMod<span style="color:#000000">)</span> <span style="color:#010181">UnloadImage</span><span style="color:#000000">(</span>srcMod<span style="color:#000000">);</span>     <span style="color:#838183; font-style:italic">// Unload source modified image</span>
    <span style="color:#000000">}</span>
<span style="color:#000000">}</span>
