<span style="color:#0057ae">void</span> <span style="color:#010181">UpdateAudioStream</span><span style="color:#000000">(</span>AudioStream stream<span style="color:#000000">,</span> <span style="color:#0057ae">const void</span> <span style="color:#000000">*</span>data<span style="color:#000000">,</span> <span style="color:#0057ae">int</span> frameCount<span style="color:#000000">){</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>stream<span style="color:#000000">.</span>buffer <span style="color:#000000">!=</span> NULL<span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>stream<span style="color:#000000">.</span>buffer<span style="color:#000000">-&gt;</span>isSubBufferProcessed<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">] ||</span> stream<span style="color:#000000">.</span>buffer<span style="color:#000000">-&gt;</span>isSubBufferProcessed<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">])</span>
        <span style="color:#000000">{</span>
            ma_uint32 subBufferToUpdate <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span>
            <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>stream<span style="color:#000000">.</span>buffer<span style="color:#000000">-&gt;</span>isSubBufferProcessed<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">] &amp;&amp;</span> stream<span style="color:#000000">.</span>buffer<span style="color:#000000">-&gt;</span>isSubBufferProcessed<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">])</span>
            <span style="color:#000000">{</span>
                <span style="color:#838183; font-style:italic">// Both buffers are available for updating.</span>
                <span style="color:#838183; font-style:italic">// Update the first one and make sure the cursor is moved back to the front.</span>
                subBufferToUpdate <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span>
                stream<span style="color:#000000">.</span>buffer<span style="color:#000000">-&gt;</span>frameCursorPos <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span>
            <span style="color:#000000">}</span>
            <span style="color:#000000; font-weight:bold">else</span>
            <span style="color:#000000">{</span>
                <span style="color:#838183; font-style:italic">// Just update whichever sub-buffer is processed.</span>
                subBufferToUpdate <span style="color:#000000">= (</span>stream<span style="color:#000000">.</span>buffer<span style="color:#000000">-&gt;</span>isSubBufferProcessed<span style="color:#000000">[</span><span style="color:#b07e00">0</span><span style="color:#000000">])?</span> <span style="color:#b07e00">0</span> <span style="color:#000000">:</span> <span style="color:#b07e00">1</span><span style="color:#000000">;</span>
            <span style="color:#000000">}</span>
            ma_uint32 subBufferSizeInFrames <span style="color:#000000">=</span> stream<span style="color:#000000">.</span>buffer<span style="color:#000000">-&gt;</span>sizeInFrames<span style="color:#000000">/</span><span style="color:#b07e00">2</span><span style="color:#000000">;</span>
            <span style="color:#0057ae">unsigned char</span> <span style="color:#000000">*</span>subBuffer <span style="color:#000000">=</span> stream<span style="color:#000000">.</span>buffer<span style="color:#000000">-&gt;</span>data <span style="color:#000000">+ ((</span>subBufferSizeInFrames<span style="color:#000000">*</span>stream<span style="color:#000000">.</span>channels<span style="color:#000000">*(</span>stream<span style="color:#000000">.</span>sampleSize<span style="color:#000000">/</span><span style="color:#b07e00">8</span><span style="color:#000000">))*</span>subBufferToUpdate<span style="color:#000000">);</span>
            <span style="color:#838183; font-style:italic">// Total frames processed in buffer is always the complete size, filled with 0 if required</span>
            stream<span style="color:#000000">.</span>buffer<span style="color:#000000">-&gt;</span>framesProcessed <span style="color:#000000">+=</span> subBufferSizeInFrames<span style="color:#000000">;</span>
            <span style="color:#838183; font-style:italic">// Does this API expect a whole buffer to be updated in one go?</span>
            <span style="color:#838183; font-style:italic">// Assuming so, but if not will need to change this logic.</span>
            <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>subBufferSizeInFrames <span style="color:#000000">&gt;= (</span>ma_uint32<span style="color:#000000">)</span>frameCount<span style="color:#000000">)</span>
            <span style="color:#000000">{</span>
                ma_uint32 framesToWrite <span style="color:#000000">= (</span>ma_uint32<span style="color:#000000">)</span>frameCount<span style="color:#000000">;</span>
                ma_uint32 bytesToWrite <span style="color:#000000">=</span> framesToWrite<span style="color:#000000">*</span>stream<span style="color:#000000">.</span>channels<span style="color:#000000">*(</span>stream<span style="color:#000000">.</span>sampleSize<span style="color:#000000">/</span><span style="color:#b07e00">8</span><span style="color:#000000">);</span>
                <span style="color:#010181">memcpy</span><span style="color:#000000">(</span>subBuffer<span style="color:#000000">,</span> data<span style="color:#000000">,</span> bytesToWrite<span style="color:#000000">);</span>
                <span style="color:#838183; font-style:italic">// Any leftover frames should be filled with zeros.</span>
                ma_uint32 leftoverFrameCount <span style="color:#000000">=</span> subBufferSizeInFrames <span style="color:#000000">-</span> framesToWrite<span style="color:#000000">;</span>
                <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>leftoverFrameCount <span style="color:#000000">&gt;</span> <span style="color:#b07e00">0</span><span style="color:#000000">)</span> <span style="color:#010181">memset</span><span style="color:#000000">(</span>subBuffer <span style="color:#000000">+</span> bytesToWrite<span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">,</span> leftoverFrameCount<span style="color:#000000">*</span>stream<span style="color:#000000">.</span>channels<span style="color:#000000">*(</span>stream<span style="color:#000000">.</span>sampleSize<span style="color:#000000">/</span><span style="color:#b07e00">8</span><span style="color:#000000">));</span>
                stream<span style="color:#000000">.</span>buffer<span style="color:#000000">-&gt;</span>isSubBufferProcessed<span style="color:#000000">[</span>subBufferToUpdate<span style="color:#000000">] =</span> <span style="color:#000000; font-weight:bold">false</span><span style="color:#000000">;</span>
            <span style="color:#000000">}</span>
            <span style="color:#000000; font-weight:bold">else</span> <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_WARNING<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;STREAM: Attempting to write too many frames to buffer&quot;</span><span style="color:#000000">);</span>
        <span style="color:#000000">}</span>
        <span style="color:#000000; font-weight:bold">else</span> <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_WARNING<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;STREAM: Buffer not available for updating&quot;</span><span style="color:#000000">);</span>
    <span style="color:#000000">}</span>
<span style="color:#000000">}</span>
