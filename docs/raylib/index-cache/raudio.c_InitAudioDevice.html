<span style="color:#0057ae">void</span> <span style="color:#010181">InitAudioDevice</span><span style="color:#000000">(</span><span style="color:#0057ae">void</span><span style="color:#000000">){</span>
    <span style="color:#838183; font-style:italic">// Init audio context</span>
    ma_context_config ctxConfig <span style="color:#000000">=</span> <span style="color:#010181">ma_context_config_init</span><span style="color:#000000">();</span>
    <span style="color:#010181">ma_log_callback_init</span><span style="color:#000000">(</span>OnLog<span style="color:#000000">,</span> NULL<span style="color:#000000">);</span>
    ma_result result <span style="color:#000000">=</span> <span style="color:#010181">ma_context_init</span><span style="color:#000000">(</span>NULL<span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">, &amp;</span>ctxConfig<span style="color:#000000">, &amp;</span>AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>context<span style="color:#000000">);</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>result <span style="color:#000000">!=</span> MA_SUCCESS<span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_WARNING<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;AUDIO: Failed to initialize context&quot;</span><span style="color:#000000">);</span>
        <span style="color:#000000; font-weight:bold">return</span><span style="color:#000000">;</span>
    <span style="color:#000000">}</span>
    <span style="color:#838183; font-style:italic">// Init audio device</span>
    <span style="color:#838183; font-style:italic">// NOTE: Using the default device. Format is floating point because it simplifies mixing.</span>
    ma_device_config config <span style="color:#000000">=</span> <span style="color:#010181">ma_device_config_init</span><span style="color:#000000">(</span>ma_device_type_playback<span style="color:#000000">);</span>
    config<span style="color:#000000">.</span>playback<span style="color:#000000">.</span>pDeviceID <span style="color:#000000">=</span> NULL<span style="color:#000000">;</span>  <span style="color:#838183; font-style:italic">// NULL for the default playback AUDIO.System.device.</span>
    config<span style="color:#000000">.</span>playback<span style="color:#000000">.</span>format <span style="color:#000000">=</span> AUDIO_DEVICE_FORMAT<span style="color:#000000">;</span>
    config<span style="color:#000000">.</span>playback<span style="color:#000000">.</span>channels <span style="color:#000000">=</span> AUDIO_DEVICE_CHANNELS<span style="color:#000000">;</span>
    config<span style="color:#000000">.</span>capture<span style="color:#000000">.</span>pDeviceID <span style="color:#000000">=</span> NULL<span style="color:#000000">;</span>  <span style="color:#838183; font-style:italic">// NULL for the default capture AUDIO.System.device.</span>
    config<span style="color:#000000">.</span>capture<span style="color:#000000">.</span>format <span style="color:#000000">=</span> ma_format_s16<span style="color:#000000">;</span>
    config<span style="color:#000000">.</span>capture<span style="color:#000000">.</span>channels <span style="color:#000000">=</span> <span style="color:#b07e00">1</span><span style="color:#000000">;</span>
    config<span style="color:#000000">.</span>sampleRate <span style="color:#000000">=</span> AUDIO_DEVICE_SAMPLE_RATE<span style="color:#000000">;</span>
    config<span style="color:#000000">.</span>dataCallback <span style="color:#000000">=</span> OnSendAudioDataToDevice<span style="color:#000000">;</span>
    config<span style="color:#000000">.</span>pUserData <span style="color:#000000">=</span> NULL<span style="color:#000000">;</span>
    result <span style="color:#000000">=</span> <span style="color:#010181">ma_device_init</span><span style="color:#000000">(&amp;</span>AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>context<span style="color:#000000">, &amp;</span>config<span style="color:#000000">, &amp;</span>AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>device<span style="color:#000000">);</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>result <span style="color:#000000">!=</span> MA_SUCCESS<span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_WARNING<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;AUDIO: Failed to initialize playback device&quot;</span><span style="color:#000000">);</span>
        <span style="color:#010181">ma_context_uninit</span><span style="color:#000000">(&amp;</span>AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>context<span style="color:#000000">);</span>
        <span style="color:#000000; font-weight:bold">return</span><span style="color:#000000">;</span>
    <span style="color:#000000">}</span>
    <span style="color:#838183; font-style:italic">// Keep the device running the whole time. May want to consider doing something a bit smarter and only have the device running</span>
    <span style="color:#838183; font-style:italic">// while there&apos;s at least one sound being played.</span>
    result <span style="color:#000000">=</span> <span style="color:#010181">ma_device_start</span><span style="color:#000000">(&amp;</span>AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>device<span style="color:#000000">);</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>result <span style="color:#000000">!=</span> MA_SUCCESS<span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_WARNING<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;AUDIO: Failed to start playback device&quot;</span><span style="color:#000000">);</span>
        <span style="color:#010181">ma_device_uninit</span><span style="color:#000000">(&amp;</span>AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>device<span style="color:#000000">);</span>
        <span style="color:#010181">ma_context_uninit</span><span style="color:#000000">(&amp;</span>AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>context<span style="color:#000000">);</span>
        <span style="color:#000000; font-weight:bold">return</span><span style="color:#000000">;</span>
    <span style="color:#000000">}</span>
    <span style="color:#838183; font-style:italic">// Mixing happens on a separate thread which means we need to synchronize. I&apos;m using a mutex here to make things simple, but may</span>
    <span style="color:#838183; font-style:italic">// want to look at something a bit smarter later on to keep everything real-time, if that&apos;s necessary.</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span><span style="color:#010181">ma_mutex_init</span><span style="color:#000000">(&amp;</span>AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>lock<span style="color:#000000">) !=</span> MA_SUCCESS<span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_WARNING<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;AUDIO: Failed to create mutex for mixing&quot;</span><span style="color:#000000">);</span>
        <span style="color:#010181">ma_device_uninit</span><span style="color:#000000">(&amp;</span>AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>device<span style="color:#000000">);</span>
        <span style="color:#010181">ma_context_uninit</span><span style="color:#000000">(&amp;</span>AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>context<span style="color:#000000">);</span>
        <span style="color:#000000; font-weight:bold">return</span><span style="color:#000000">;</span>
    <span style="color:#000000">}</span>
    <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_INFO<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;AUDIO: Device initialized successfully&quot;</span><span style="color:#000000">);</span>
    <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_INFO<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;    &gt; Backend:       miniaudio / %s&quot;</span><span style="color:#000000">,</span> <span style="color:#010181">ma_get_backend_name</span><span style="color:#000000">(</span>AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>context<span style="color:#000000">.</span>backend<span style="color:#000000">));</span>
    <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_INFO<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;    &gt; Format:        %s -&gt; %s&quot;</span><span style="color:#000000">,</span> <span style="color:#010181">ma_get_format_name</span><span style="color:#000000">(</span>AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>device<span style="color:#000000">.</span>playback<span style="color:#000000">.</span>format<span style="color:#000000">),</span> <span style="color:#010181">ma_get_format_name</span><span style="color:#000000">(</span>AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>device<span style="color:#000000">.</span>playback<span style="color:#000000">.</span>internalFormat<span style="color:#000000">));</span>
    <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_INFO<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;    &gt; Channels:      %d -&gt; %d&quot;</span><span style="color:#000000">,</span> AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>device<span style="color:#000000">.</span>playback<span style="color:#000000">.</span>channels<span style="color:#000000">,</span> AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>device<span style="color:#000000">.</span>playback<span style="color:#000000">.</span>internalChannels<span style="color:#000000">);</span>
    <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_INFO<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;    &gt; Sample rate:   %d -&gt; %d&quot;</span><span style="color:#000000">,</span> AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>device<span style="color:#000000">.</span>sampleRate<span style="color:#000000">,</span> AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>device<span style="color:#000000">.</span>playback<span style="color:#000000">.</span>internalSampleRate<span style="color:#000000">);</span>
    <span style="color:#010181">TRACELOG</span><span style="color:#000000">(</span>LOG_INFO<span style="color:#000000">,</span> <span style="color:#bf0303">&quot;    &gt; Periods size:  %d&quot;</span><span style="color:#000000">,</span> AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>device<span style="color:#000000">.</span>playback<span style="color:#000000">.</span>internalPeriodSizeInFrames<span style="color:#000000">*</span>AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>device<span style="color:#000000">.</span>playback<span style="color:#000000">.</span>internalPeriods<span style="color:#000000">);</span>
    AUDIO<span style="color:#000000">.</span>System<span style="color:#000000">.</span>isReady <span style="color:#000000">=</span> <span style="color:#000000; font-weight:bold">true</span><span style="color:#000000">;</span>
<span style="color:#000000">}</span>
