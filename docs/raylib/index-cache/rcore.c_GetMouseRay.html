Ray <span style="color:#010181">GetMouseRay</span><span style="color:#000000">(</span>Vector2 mouse<span style="color:#000000">,</span> Camera camera<span style="color:#000000">){</span>
    Ray ray <span style="color:#000000">= {</span> <span style="color:#b07e00">0</span> <span style="color:#000000">};</span>
    <span style="color:#838183; font-style:italic">// Calculate normalized device coordinates</span>
    <span style="color:#838183; font-style:italic">// NOTE: y value is negative</span>
    <span style="color:#0057ae">float</span> x <span style="color:#000000">= (</span><span style="color:#b07e00">2.0</span>f<span style="color:#000000">*</span>mouse<span style="color:#000000">.</span>x<span style="color:#000000">)/(</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span><span style="color:#010181">GetScreenWidth</span><span style="color:#000000">() -</span> <span style="color:#b07e00">1.0</span>f<span style="color:#000000">;</span>
    <span style="color:#0057ae">float</span> y <span style="color:#000000">=</span> <span style="color:#b07e00">1.0</span>f <span style="color:#000000">- (</span><span style="color:#b07e00">2.0</span>f<span style="color:#000000">*</span>mouse<span style="color:#000000">.</span>y<span style="color:#000000">)/(</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span><span style="color:#010181">GetScreenHeight</span><span style="color:#000000">();</span>
    <span style="color:#0057ae">float</span> z <span style="color:#000000">=</span> <span style="color:#b07e00">1.0</span>f<span style="color:#000000">;</span>
    <span style="color:#838183; font-style:italic">// Store values in a vector</span>
    Vector3 deviceCoords <span style="color:#000000">= {</span> x<span style="color:#000000">,</span> y<span style="color:#000000">,</span> z <span style="color:#000000">};</span>
    <span style="color:#838183; font-style:italic">// Calculate view matrix from camera look at</span>
    Matrix matView <span style="color:#000000">=</span> <span style="color:#010181">MatrixLookAt</span><span style="color:#000000">(</span>camera<span style="color:#000000">.</span>position<span style="color:#000000">,</span> camera<span style="color:#000000">.</span>target<span style="color:#000000">,</span> camera<span style="color:#000000">.</span>up<span style="color:#000000">);</span>
    Matrix matProj <span style="color:#000000">=</span> <span style="color:#010181">MatrixIdentity</span><span style="color:#000000">();</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>camera<span style="color:#000000">.</span>projection <span style="color:#000000">==</span> CAMERA_PERSPECTIVE<span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#838183; font-style:italic">// Calculate projection matrix from perspective</span>
        matProj <span style="color:#000000">=</span> <span style="color:#010181">MatrixPerspective</span><span style="color:#000000">(</span>camera<span style="color:#000000">.</span>fovy<span style="color:#000000">*</span>DEG2RAD<span style="color:#000000">, ((</span><span style="color:#0057ae">double</span><span style="color:#000000">)</span><span style="color:#010181">GetScreenWidth</span><span style="color:#000000">()/(</span><span style="color:#0057ae">double</span><span style="color:#000000">)</span><span style="color:#010181">GetScreenHeight</span><span style="color:#000000">()),</span> RL_CULL_DISTANCE_NEAR<span style="color:#000000">,</span> RL_CULL_DISTANCE_FAR<span style="color:#000000">);</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">else if</span> <span style="color:#000000">(</span>camera<span style="color:#000000">.</span>projection <span style="color:#000000">==</span> CAMERA_ORTHOGRAPHIC<span style="color:#000000">)</span>
    <span style="color:#000000">{</span>
        <span style="color:#0057ae">float</span> aspect <span style="color:#000000">= (</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>CORE<span style="color:#000000">.</span>Window<span style="color:#000000">.</span>screen<span style="color:#000000">.</span>width<span style="color:#000000">/(</span><span style="color:#0057ae">float</span><span style="color:#000000">)</span>CORE<span style="color:#000000">.</span>Window<span style="color:#000000">.</span>screen<span style="color:#000000">.</span>height<span style="color:#000000">;</span>
        <span style="color:#0057ae">double</span> top <span style="color:#000000">=</span> camera<span style="color:#000000">.</span>fovy<span style="color:#000000">/</span><span style="color:#b07e00">2.0</span><span style="color:#000000">;</span>
        <span style="color:#0057ae">double</span> right <span style="color:#000000">=</span> top<span style="color:#000000">*</span>aspect<span style="color:#000000">;</span>
        <span style="color:#838183; font-style:italic">// Calculate projection matrix from orthographic</span>
        matProj <span style="color:#000000">=</span> <span style="color:#010181">MatrixOrtho</span><span style="color:#000000">(-</span>right<span style="color:#000000">,</span> right<span style="color:#000000">, -</span>top<span style="color:#000000">,</span> top<span style="color:#000000">,</span> <span style="color:#b07e00">0.01</span><span style="color:#000000">,</span> <span style="color:#b07e00">1000.0</span><span style="color:#000000">);</span>
    <span style="color:#000000">}</span>
    <span style="color:#838183; font-style:italic">// Unproject far/near points</span>
    Vector3 nearPoint <span style="color:#000000">=</span> <span style="color:#010181">Vector3Unproject</span><span style="color:#000000">((</span>Vector3<span style="color:#000000">){</span> deviceCoords<span style="color:#000000">.</span>x<span style="color:#000000">,</span> deviceCoords<span style="color:#000000">.</span>y<span style="color:#000000">,</span> <span style="color:#b07e00">0.0</span>f <span style="color:#000000">},</span> matProj<span style="color:#000000">,</span> matView<span style="color:#000000">);</span>
    Vector3 farPoint <span style="color:#000000">=</span> <span style="color:#010181">Vector3Unproject</span><span style="color:#000000">((</span>Vector3<span style="color:#000000">){</span> deviceCoords<span style="color:#000000">.</span>x<span style="color:#000000">,</span> deviceCoords<span style="color:#000000">.</span>y<span style="color:#000000">,</span> <span style="color:#b07e00">1.0</span>f <span style="color:#000000">},</span> matProj<span style="color:#000000">,</span> matView<span style="color:#000000">);</span>
    <span style="color:#838183; font-style:italic">// Unproject the mouse cursor in the near plane.</span>
    <span style="color:#838183; font-style:italic">// We need this as the source position because orthographic projects, compared to perspective doesn&apos;t have a</span>
    <span style="color:#838183; font-style:italic">// convergence point, meaning that the &quot;eye&quot; of the camera is more like a plane than a point.</span>
    Vector3 cameraPlanePointerPos <span style="color:#000000">=</span> <span style="color:#010181">Vector3Unproject</span><span style="color:#000000">((</span>Vector3<span style="color:#000000">){</span> deviceCoords<span style="color:#000000">.</span>x<span style="color:#000000">,</span> deviceCoords<span style="color:#000000">.</span>y<span style="color:#000000">, -</span><span style="color:#b07e00">1.0</span>f <span style="color:#000000">},</span> matProj<span style="color:#000000">,</span> matView<span style="color:#000000">);</span>
    <span style="color:#838183; font-style:italic">// Calculate normalized direction vector</span>
    Vector3 direction <span style="color:#000000">=</span> <span style="color:#010181">Vector3Normalize</span><span style="color:#000000">(</span><span style="color:#010181">Vector3Subtract</span><span style="color:#000000">(</span>farPoint<span style="color:#000000">,</span> nearPoint<span style="color:#000000">));</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>camera<span style="color:#000000">.</span>projection <span style="color:#000000">==</span> CAMERA_PERSPECTIVE<span style="color:#000000">)</span> ray<span style="color:#000000">.</span>position <span style="color:#000000">=</span> camera<span style="color:#000000">.</span>position<span style="color:#000000">;</span>
    <span style="color:#000000; font-weight:bold">else if</span> <span style="color:#000000">(</span>camera<span style="color:#000000">.</span>projection <span style="color:#000000">==</span> CAMERA_ORTHOGRAPHIC<span style="color:#000000">)</span> ray<span style="color:#000000">.</span>position <span style="color:#000000">=</span> cameraPlanePointerPos<span style="color:#000000">;</span>
    <span style="color:#838183; font-style:italic">// Apply calculated vectors to ray</span>
    ray<span style="color:#000000">.</span>direction <span style="color:#000000">=</span> direction<span style="color:#000000">;</span>
    <span style="color:#000000; font-weight:bold">return</span> ray<span style="color:#000000">;</span>
<span style="color:#000000">}</span>
